<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLOOMBERG ENS® - LIVE TERMINAL</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            --bg-color: #000000;
            --panel-bg: #0a0a0a;
            --border: #333333;
            --text-main: #ffaa00; /* Bloomberg Amber */
            --text-dim: #666666;
            --up-color: #00ff00;
            --down-color: #ff0000;
            --font-stack: 'Courier New', 'Consolas', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-stack);
            font-size: 11px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- HEADER & COMMAND --- */
        .top-bar {
            background: var(--text-main);
            color: #000;
            padding: 4px 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }
        
        .cmd-line {
            background: #111;
            border-bottom: 1px solid var(--text-main);
            padding: 5px 10px;
            display: flex;
            align-items: center;
        }
        .cmd-input {
            background: transparent;
            border: none;
            color: var(--text-main);
            font-family: inherit;
            margin-left: 10px;
            width: 300px;
            text-transform: uppercase;
            outline: none;
        }

        /* --- LAYOUT GRID --- */
        .grid-container {
            display: grid;
            grid-template-columns: 280px 1fr 280px; /* Gauche - Centre - Droite */
            grid-template-rows: 1fr 180px; /* Haut - Bas */
            gap: 1px;
            background-color: var(--border); /* Crée les bordures entre les panels */
            flex-grow: 1;
        }

        .panel {
            background-color: var(--bg-color);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            background: #111;
            padding: 3px 8px;
            border-bottom: 1px solid var(--border);
            font-weight: bold;
            color: var(--text-dim);
            font-size: 10px;
            display: flex;
            justify-content: space-between;
        }

        /* --- COMPONENTS --- */
        
        /* Order Book */
        .order-book { overflow-y: hidden; flex-grow: 1; font-size: 10px; }
        .ob-row { display: flex; justify-content: space-between; padding: 1px 8px; position: relative; }
        .ob-bg { position: absolute; top: 0; bottom: 0; right: 0; opacity: 0.2; z-index: 0; }
        .ob-ask .ob-bg { background: var(--down-color); }
        .ob-bid .ob-bg { background: var(--up-color); }
        .ob-val { z-index: 1; position: relative; }
        .ask-text { color: var(--down-color); }
        .bid-text { color: var(--up-color); }

        /* Chart Container */
        #chart-container { width: 100%; height: 100%; }

        /* Ticker Tape (Trades) */
        .tape-list { overflow: hidden; }
        .trade-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 2px 8px; 
            border-bottom: 1px solid #111;
        }
        .trade-buy { color: var(--up-color); }
        .trade-sell { color: var(--down-color); }

        /* Stats Panel */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            padding: 10px;
            gap: 15px;
        }
        .stat-box { border: 1px solid var(--border); padding: 5px; }
        .stat-label { color: var(--text-dim); font-size: 9px; margin-bottom: 2px; }
        .stat-value { font-size: 14px; font-weight: bold; }

        /* Footer */
        .footer {
            background: #111;
            padding: 4px 10px;
            color: var(--text-dim);
            font-size: 9px;
            display: flex;
            justify-content: space-between;
            border-top: 1px solid var(--border);
        }
        .connection-status { color: var(--up-color); }

        /* Blinking effect */
        @keyframes flash { 0% { background: #333; } 100% { background: transparent; } }
        .flash { animation: flash 0.5s; }

    </style>
</head>
<body>

    <div class="top-bar">
        <span>BLOOMBERG ENS TERMINAL</span>
        <span id="clock">--:--:-- UTC</span>
    </div>
    <div class="cmd-line">
        <span>COMMAND ></span>
        <input type="text" class="cmd-input" value="BTCUSDT" id="pair-input" placeholder="ENTER PAIR...">
        <span style="color:var(--text-dim)">[PRESS ENTER TO LOAD]</span>
    </div>

    <div class="grid-container">
        
        <div class="panel" style="grid-row: span 2;">
            <div class="panel-header">
                <span>ORDER BOOK (DEPTH)</span>
                <span>BTC/USDT</span>
            </div>
            <div style="display:flex; justify-content:space-between; padding:4px 8px; color:var(--text-dim); font-size:9px;">
                <span>PRICE</span><span>SIZE</span>
            </div>
            <div id="asks-container" class="order-book" style="border-bottom:1px solid var(--border);"></div>
            <div id="spread-display" style="text-align:center; padding:2px; color:var(--text-dim);">SPREAD: --</div>
            <div id="bids-container" class="order-book"></div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <span>CHART: LIVE FEED (1M)</span>
                <span id="current-price-header" style="font-size:12px; color: var(--text-main);">LOADING...</span>
            </div>
            <div id="chart-container"></div>
        </div>

        <div class="panel" style="grid-row: span 2;">
            <div class="panel-header">
                <span>TAPE (REAL-TIME TRADES)</span>
                <span>VOL</span>
            </div>
            <div id="tape-container" class="tape-list">
                </div>
        </div>

        <div class="panel">
            <div class="panel-header">MARKET INTELLIGENCE</div>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">FEAR & GREED</div>
                    <div class="stat-value" id="fng-value">--</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">24H VOL (BTC)</div>
                    <div class="stat-value" id="vol-value">--</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">24H HIGH</div>
                    <div class="stat-value" id="high-value">--</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">ETH GAS (EST)</div>
                    <div class="stat-value" id="gas-value">~15 Gwei</div>
                </div>
            </div>
        </div>

    </div>

    <div class="footer">
        <div>SYSTEM STATUS: <span class="connection-status">● STREAMING DATA</span></div>
        <div>DATA SOURCE: BINANCE PUBLIC API • ALTERNATIVE.ME</div>
    </div>

    <script>
        // --- CONFIGURATION ---
        let currentPair = 'btcusdt';
        let ws = null;
        let chart, candleSeries;

        // --- 1. INITIALISATION CHART (Lightweight Charts) ---
        function initChart() {
            const chartContainer = document.getElementById('chart-container');
            chart = LightweightCharts.createChart(chartContainer, {
                layout: { background: { color: '#000000' }, textColor: '#ffaa00' },
                grid: { vertLines: { color: '#1a1a1a' }, horzLines: { color: '#1a1a1a' } },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                rightPriceScale: { borderColor: '#333' },
                timeScale: { borderColor: '#333' },
            });

            candleSeries = chart.addCandlestickSeries({
                upColor: '#00ff00',
                downColor: '#ff0000',
                borderVisible: false,
                wickUpColor: '#00ff00',
                wickDownColor: '#ff0000',
            });
            
            // Adapter le graphique à la fenêtre
            new ResizeObserver(entries => {
                if (entries.length === 0 || entries[0].target !== chartContainer) { return; }
                const newRect = entries[0].contentRect;
                chart.applyOptions({ width: newRect.width, height: newRect.height });
            }).observe(chartContainer);
        }

        // --- 2. WEBSOCKET MANAGER ---
        function connectWebSocket(pair) {
            if (ws) ws.close();

            // On se connecte à 3 flux: kline (bougies), depth (carnet), trade (tape)
            const streams = [
                `${pair}@kline_1m`,
                `${pair}@depth20`, // Top 20 bids/asks
                `${pair}@trade`
            ].join('/');

            ws = new WebSocket(`wss://stream.binance.com:9443/stream?streams=${streams}`);

            ws.onopen = () => console.log('Connected to Binance WS');
            
            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                const type = message.stream.split('@')[1]; // kline_1m, depth20, trade
                const data = message.data;

                if (type === 'kline_1m') handleKline(data);
                if (type === 'depth20') handleDepth(data);
                if (type === 'trade') handleTrade(data);
            };
        }

        // --- 3. DATA HANDLERS ---

        function handleKline(data) {
            const k = data.k;
            const candle = {
                time: k.t / 1000,
                open: parseFloat(k.o),
                high: parseFloat(k.h),
                low: parseFloat(k.l),
                close: parseFloat(k.c),
            };
            candleSeries.update(candle);
            
            // Update stats header
            document.getElementById('current-price-header').innerText = parseFloat(k.c).toFixed(2);
            document.getElementById('vol-value').innerText = parseFloat(k.v).toFixed(0);
            document.getElementById('high-value').innerText = parseFloat(k.h).toFixed(2);
        }

        function handleDepth(data) {
            // Asks (Vendeurs - Rouge) - On inverse pour avoir le prix le plus bas en bas
            const asksContainer = document.getElementById('asks-container');
            asksContainer.innerHTML = '';
            // On prend les 10 premiers, on les inverse pour l'affichage vertical
            data.asks.slice(0, 15).reverse().forEach(ask => {
                asksContainer.appendChild(createOrderRow(ask, 'ob-ask'));
            });

            // Bids (Acheteurs - Vert)
            const bidsContainer = document.getElementById('bids-container');
            bidsContainer.innerHTML = '';
            data.bids.slice(0, 15).forEach(bid => {
                bidsContainer.appendChild(createOrderRow(bid, 'ob-bid'));
            });

            // Spread
            const bestAsk = parseFloat(data.asks[0][0]);
            const bestBid = parseFloat(data.bids[0][0]);
            const spread = (bestAsk - bestBid).toFixed(2);
            document.getElementById('spread-display').innerText = `SPREAD: ${spread}`;
        }

        function createOrderRow(item, typeClass) {
            const price = parseFloat(item[0]).toFixed(2);
            const size = parseFloat(item[1]).toFixed(4);
            // Simuler une barre de profondeur (visuel)
            const width = Math.min((size * 10), 100); 
            
            const div = document.createElement('div');
            div.className = `ob-row ${typeClass}`;
            div.innerHTML = `
                <div class="ob-bg" style="width:${width}%"></div>
                <span class="ob-val ${typeClass === 'ob-ask' ? 'ask-text' : 'bid-text'}">${price}</span>
                <span class="ob-val" style="color:#888">${size}</span>
            `;
            return div;
        }

        function handleTrade(data) {
            const container = document.getElementById('tape-container');
            const row = document.createElement('div');
            row.className = 'trade-item';
            
            const price = parseFloat(data.p).toFixed(2);
            const size = parseFloat(data.q).toFixed(5);
            const isBuyerMaker = data.m; // true = sell order triggered (rouge), false = buy (vert)
            
            row.innerHTML = `
                <span style="color:#666">${new Date(data.T).toLocaleTimeString().split(' ')[0]}</span>
                <span class="${isBuyerMaker ? 'trade-sell' : 'trade-buy'}">${price}</span>
                <span style="color:#aaa">${size}</span>
            `;

            container.prepend(row);
            // Limiter à 50 lignes pour la performance
            if (container.children.length > 50) {
                container.lastChild.remove();
            }
        }

        // --- 4. API EXTERNES (REST) ---
        async function fetchHistory(pair) {
            // Récupérer les 1000 dernières bougies pour initialiser le graph
            const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${pair.toUpperCase()}&interval=1m&limit=1000`);
            const data = await res.json();
            const candles = data.map(d => ({
                time: d[0] / 1000,
                open: parseFloat(d[1]),
                high: parseFloat(d[2]),
                low: parseFloat(d[3]),
                close: parseFloat(d[4]),
            }));
            candleSeries.setData(candles);
        }

        async function fetchSentiment() {
            try {
                const res = await fetch('https://api.alternative.me/fng/');
                const data = await res.json();
                const fng = data.data[0];
                const el = document.getElementById('fng-value');
                el.innerText = fng.value;
                el.style.color = fng.value > 50 ? '#00ff00' : '#ff0000';
            } catch(e) { console.log(e); }
        }

        // --- 5. UTILITAIRES ---
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toISOString().split('T')[1].split('.')[0] + ' UTC';
        }

        // Input Handler
        document.getElementById('pair-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                const newPair = this.value.toLowerCase().trim();
                if(newPair) {
                    currentPair = newPair;
                    startTerminal();
                }
            }
        });

        // --- START ---
        async function startTerminal() {
            document.getElementById('asks-container').innerHTML = '';
            document.getElementById('bids-container').innerHTML = '';
            document.getElementById('tape-container').innerHTML = '';
            
            await fetchHistory(currentPair); // 1. Historique
            connectWebSocket(currentPair);   // 2. Live data
            fetchSentiment();                // 3. Sentiment
        }

        // Init sequence
        initChart();
        startTerminal();
        setInterval(updateClock, 1000);

    </script>
</body>
</html>
