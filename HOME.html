<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLOOMBERG ENS¬Æ - ULTIMATE TRADER v8</title>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <style>
        :root { --bg: #000; --amber: #ffaa00; --dim: #666; --green: #0f0; --red: #f00; --liq: #d900ff; --border: #333; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Courier New', monospace; user-select: none; }
        body { background: var(--bg); color: var(--amber); height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-size: 10px; }
        
        /* SCROLLBARS */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; }

        /* ANIMATIONS */
        @keyframes flash { 0% { background-color: #333; } 100% { background-color: transparent; } }
        .flash-up { animation: flash 0.5s; color: var(--green); }
        .flash-down { animation: flash 0.5s; color: var(--red); }
        .flash-liq { animation: flash 1s; background-color: rgba(217, 0, 255, 0.2); color: var(--liq); font-weight: bold; }

        /* TICKER */
        .ticker-wrap { width: 100%; overflow: hidden; background: #111; border-bottom: 1px solid var(--amber); white-space: nowrap; padding: 4px 0; }
        .ticker { display: inline-block; animation: ticker 40s linear infinite; }
        @keyframes ticker { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .tick-item { margin-right: 25px; font-weight: bold; cursor: pointer; }
        .tick-item:hover { color: #fff; text-decoration: underline; }

        /* HEADER */
        .header { background: var(--amber); color: #000; padding: 2px 10px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .funding { background: #000; color: var(--amber); padding: 1px 6px; border-radius: 2px; font-size: 9px; }

        /* LAYOUT */
        .grid { display: grid; grid-template-columns: 240px 1fr 280px; grid-template-rows: 30px 1fr 160px; gap: 1px; background: var(--border); flex-grow: 1; }
        .panel { background: var(--bg); display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .title { background: #111; padding: 3px 5px; border-bottom: 1px solid var(--border); color: var(--dim); font-weight: bold; display: flex; justify-content: space-between; font-size: 9px; }

        /* TABS */
        .tabs-bar { grid-column: span 3; background: #000; display: flex; align-items: center; border-bottom: 1px solid var(--border); padding: 0 10px; gap: 2px; }
        .tab-btn { background: #111; border: 1px solid #333; color: #666; padding: 3px 10px; cursor: pointer; font-size: 9px; min-width: 60px; }
        .tab-btn:hover { color: #fff; }
        .tab-btn.active { background: var(--amber); color: #000; border-color: var(--amber); font-weight: bold; }
        .tab-spacer { flex-grow: 1; }
        .pair-badge { color: var(--amber); font-weight: bold; font-size: 11px; padding-right: 10px; }

        /* PAPER TRADING PANEL */
        .trade-panel { padding: 10px; display: flex; flex-direction: column; gap: 8px; border-bottom: 1px solid #333; }
        .wallet-row { display: flex; justify-content: space-between; color: #888; font-size: 9px; }
        .wallet-val { color: #fff; font-weight: bold; }
        .trade-inputs { display: flex; gap: 5px; }
        .t-input { background: #111; border: 1px solid #333; color: #fff; padding: 4px; width: 100%; text-align: right; font-weight: bold; }
        .btn-row { display: flex; gap: 5px; }
        .btn-trade { flex: 1; padding: 6px; border: none; cursor: pointer; font-weight: bold; color: #000; opacity: 0.9; }
        .btn-buy { background: var(--green); } .btn-sell { background: var(--red); }
        .btn-trade:hover { opacity: 1; transform: scale(0.98); }
        .btn-trade:active { transform: scale(0.95); }
        
        .position-box { background: #111; border: 1px solid #333; padding: 5px; display: none; margin-top: 5px; }
        .pos-header { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 9px; color: #666; }
        .pnl-disp { font-size: 14px; font-weight: bold; text-align: center; margin: 5px 0; }
        .btn-close { width: 100%; background: #333; color: #fff; border: 1px solid #555; cursor: pointer; padding: 2px; font-size: 9px; }
        .btn-close:hover { background: #555; }

        /* LISTS */
        .list { overflow-y: auto; flex-grow: 1; }
        .row { display: flex; justify-content: space-between; padding: 1px 6px; font-size: 10px; border-bottom: 1px solid #080808; }
        .whale { color: var(--amber); font-weight: bold; background: rgba(255, 170, 0, 0.1); }
        .rekt { color: var(--liq); font-weight: bold; text-shadow: 0 0 5px var(--liq); }
        
        /* STATS & FOOTER */
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 10px; }
        .box { border: 1px solid var(--border); padding: 5px; display: flex; flex-direction: column; justify-content: center; }
        .s-lbl { color: #666; font-size: 8px; text-transform: uppercase; }
        .s-val { font-size: 12px; font-weight: bold; }
        
        .foot { background: #111; border-top: 1px solid #333; padding: 2px 10px; color: var(--dim); display: flex; justify-content: space-between; font-size: 9px; align-items: center; }
        .btn-fs { background: transparent; border: 1px solid #444; color: #888; cursor: pointer; padding: 0 6px; }

        #tv-container, #gauge-container { width: 100%; height: 100%; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="ticker-wrap">
        <div class="ticker" id="global-ticker">INITIALIZING MARKET DATA STREAM...</div>
    </div>

    <div class="header">
        <span>BLOOMBERG ENS TERMINAL v8.0 [ULTIMATE]</span>
        <div style="display:flex; gap:15px; align-items:center;">
            <span class="funding">FUNDING: <span id="funding-rate">--%</span></span>
            <span id="time">--:--:-- UTC</span>
        </div>
    </div>

    <div class="grid">
        <div class="tabs-bar">
            <span class="pair-badge" id="current-pair-disp">BTCUSDT</span>
            <button class="tab-btn active" onclick="setTab('chart')">CHART</button>
            <button class="tab-btn" onclick="setTab('depth')">DEPTH</button>
            <button class="tab-btn" onclick="setTab('news')">NEWS</button>
            <div class="tab-spacer"></div>
            <button class="tab-btn" onclick="changeTf('1')">1m</button>
            <button class="tab-btn" onclick="changeTf('15')">15m</button>
            <button class="tab-btn" onclick="changeTf('60')">1H</button>
            <button class="tab-btn" onclick="changeTf('240')">4H</button>
        </div>

        <div class="panel" style="grid-row: span 2;">
            
            <div class="title"><span style="color:var(--green)">PAPER TRADING (SIM)</span><span>WALLET</span></div>
            <div class="trade-panel">
                <div class="wallet-row"><span>BALANCE</span><span class="wallet-val" id="wallet-bal">$10,000.00</span></div>
                <div class="trade-inputs">
                    <input type="number" id="trade-size" class="t-input" placeholder="SIZE (USD)" value="1000">
                </div>
                <div class="btn-row">
                    <button class="btn-trade btn-buy" onclick="openPosition('long')">BUY / LONG</button>
                    <button class="btn-trade btn-sell" onclick="openPosition('short')">SELL / SHORT</button>
                </div>
                <div id="position-box" class="position-box">
                    <div class="pos-header">
                        <span id="pos-side">LONG</span>
                        <span>ENTRY: <span id="pos-entry">--</span></span>
                    </div>
                    <div class="pnl-disp" id="pos-pnl">$0.00</div>
                    <button class="btn-close" onclick="closePosition()">CLOSE POSITION</button>
                </div>
            </div>

            <div class="title"><span>MARKET WATCH</span><span>SELECT</span></div>
            <div id="watchlist" class="list" style="max-height: 250px;"></div>

            <div class="title"><span>ORDER BOOK</span><span>DEPTH</span></div>
            <div class="list">
                <div id="asks" style="display:flex; flex-direction:column-reverse;"></div>
                <div id="spread" style="text-align:center; color:#444; border-top:1px solid #222; border-bottom:1px solid #222;">-</div>
                <div id="bids"></div>
            </div>
        </div>

        <div class="panel" style="grid-row: span 2;">
            <div id="tv-container"></div>
            <div id="gauge-container" class="hidden"></div> </div>

        <div class="panel">
            <div class="title"><span>TAPE & LIQUIDATIONS</span><span>REAL-TIME</span></div>
            <div id="tape" class="list"></div>
        </div>
        
        <div class="panel">
            <div class="title"><span>SENTIMENT</span><span>TECH</span></div>
            <div id="mini-gauge" style="flex:1"></div>
        </div>
    </div>

    <div class="grid" style="grid-template-columns: 1fr; grid-template-rows: 1fr; min-height: 60px; background:var(--bg); flex-grow:0;">
        <div class="stats">
            <div class="box"><span class="s-lbl">24H HIGH</span><span class="s-val" id="high">--</span></div>
            <div class="box"><span class="s-lbl">24H LOW</span><span class="s-val" id="low">--</span></div>
            <div class="box"><span class="s-lbl">VOLUME</span><span class="s-val" id="vol">--</span></div>
            <div class="box"><span class="s-lbl">CHANGE</span><span class="s-val" id="chg">--</span></div>
        </div>
    </div>

    <div class="foot">
        <div style="display:flex; gap:15px; align-items:center;">
            <span id="status" style="color:var(--green)">‚óè SYSTEM ONLINE</span>
            <span id="ping">PING: --ms</span>
            <span style="color:var(--dim)">| SOUND FX: CLICK TO ENABLE</span>
        </div>
        <div style="display:flex; gap:10px;">
            <input type="text" id="cmd-input" style="background:#000; border:1px solid #333; color:var(--amber); width:100px; text-transform:uppercase; text-align:center;" placeholder="COMMAND...">
            <button class="btn-fs" onclick="toggleFs()">[ FS ]</button>
        </div>
    </div>

    <script>
        // --- CORE CONFIG ---
        let ws = null, tickerWs = null;
        let currentPair = 'btcusdt';
        let currentPrice = 0;
        let currentTimeframe = '1';
        let audioCtx = null; // Pour le son
        
        // --- PAPER TRADING STATE ---
        let wallet = 10000;
        let position = null; // { side: 'long'/'short', entry: 0, size: 0 (usd), amount: 0 (coin) }

        const el = id => document.getElementById(id);
        const log = msg => el('status').innerText = "‚óè " + msg;

        // HORLOGE
        setInterval(() => el('time').innerText = new Date().toISOString().split('T')[1].split('.')[0] + ' UTC', 1000);

        // --- 1. AUDIO ENGINE (Sonar) ---
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        function playSonar() {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(800, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.2);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.2);
        }
        document.body.addEventListener('click', initAudio); // Activation au clic

        // --- 2. PAPER TRADING LOGIC ---
        function openPosition(side) {
            if (position) return alert("Close current position first!");
            const sizeUsd = parseFloat(el('trade-size').value);
            if (sizeUsd > wallet) return alert("Insufficient funds!");
            if (currentPrice === 0) return alert("Waiting for price data...");

            // Fee fictive de 0.1%
            const fee = sizeUsd * 0.001;
            wallet -= fee;
            
            position = {
                side: side,
                entry: currentPrice,
                size: sizeUsd,
                amount: sizeUsd / currentPrice
            };
            
            el('position-box').style.display = 'block';
            el('pos-side').innerText = side.toUpperCase();
            el('pos-side').style.color = side === 'long' ? 'var(--green)' : 'var(--red)';
            el('pos-entry').innerText = currentPrice.toFixed(2);
            updateWalletUI();
        }

        function closePosition() {
            if (!position) return;
            const pnl = getPnl();
            wallet += pnl;
            position = null;
            el('position-box').style.display = 'none';
            updateWalletUI();
        }

        function getPnl() {
            if (!position) return 0;
            const diff = currentPrice - position.entry;
            // Long: (Prix - Entry) * Amount
            // Short: (Entry - Prix) * Amount
            let val = position.side === 'long' ? diff : -diff;
            return val * position.amount;
        }

        function updateWalletUI() {
            el('wallet-bal').innerText = "$" + wallet.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        function updatePnlDisplay() {
            if (!position) return;
            const pnl = getPnl();
            const elPnl = el('pos-pnl');
            elPnl.innerText = (pnl >= 0 ? "+" : "") + "$" + pnl.toFixed(2);
            elPnl.style.color = pnl >= 0 ? 'var(--green)' : 'var(--red)';
        }

        // --- 3. STREAMING ENGINE ---
        function startStream(pair) {
            if (ws) ws.close();
            log("SYNC " + pair.toUpperCase());
            
            // Flux: Depth, Trade, Ticker, MarkPrice (pour funding), ForceOrder (Liquidations)
            const streams = [
                `${pair}@depth10`, 
                `${pair}@trade`, 
                `${pair}@ticker`,
                `${pair}@markPrice@1s`,
                `${pair}@forceOrder`
            ].join('/');

            ws = new WebSocket(`wss://stream.binance.com:9443/stream?streams=${streams}`);

            ws.onopen = () => { el('status').style.color = "#0f0"; };
            ws.onmessage = (evt) => {
                const msg = JSON.parse(evt.data);
                const data = msg.data;
                const type = msg.stream.split('@')[1];

                if (type === 'trade') handleTrade(data);
                if (type === 'depth10') handleDepth(data);
                if (type === 'ticker') handleTicker(data);
                if (type === 'markPrice') handleMarkPrice(data);
                if (type === 'forceOrder') handleLiquidation(data);
            };
        }

        function handleTrade(data) {
            currentPrice = parseFloat(data.p);
            const size = parseFloat(data.q);
            const usdVal = currentPrice * size;
            
            // P&L Live update
            updatePnlDisplay();

            // Tape Logic
            const row = document.createElement('div');
            row.className = 'row';
            let styleClass = data.m ? 'r' : 'g'; // Sell or Buy
            let icon = '';

            // WHALE DETECTOR (> 50k$)
            if (usdVal > 50000) {
                row.classList.add('whale');
                icon = 'üêã ';
                playSonar(); // SOUND FX
            }

            row.innerHTML = `
                <span style="color:#666">${new Date(data.T).toLocaleTimeString().split(' ')[0]}</span>
                <span class="${styleClass}">${icon}${currentPrice.toFixed(2)}</span>
                <span style="color:#888">${size.toFixed(4)}</span>
            `;
            const tape = el('tape');
            tape.prepend(row);
            if (tape.children.length > 30) tape.lastChild.remove();
        }

        function handleLiquidation(data) {
            // REKTOMETER Logic
            const o = data.o; // Order info
            const row = document.createElement('div');
            row.className = 'row flash-liq';
            const side = o.S === 'SELL' ? 'LONG REKT' : 'SHORT REKT'; // Sell order = Long liquidation
            row.innerHTML = `
                <span>‚ò†Ô∏è ${side}</span>
                <span>$${parseFloat(o.p).toFixed(2)}</span>
                <span>VOL: ${parseFloat(o.q).toFixed(3)}</span>
            `;
            el('tape').prepend(row);
        }

        function handleDepth(data) {
            renderBook(data.asks, el('asks'), 'r', true);
            renderBook(data.bids, el('bids'), 'g', false);
            const spread = parseFloat(data.asks[0][0]) - parseFloat(data.bids[0][0]);
            el('spread').innerText = spread.toFixed(2);
        }

        function renderBook(list, container, cls, rev) {
            container.innerHTML = '';
            const arr = rev ? list.slice(0,10).reverse() : list.slice(0,10);
            arr.forEach(i => {
                const d = document.createElement('div');
                d.className = 'row';
                d.innerHTML = `<span class="${cls}">${parseFloat(i[0]).toFixed(2)}</span><span>${parseFloat(i[1]).toFixed(4)}</span>`;
                container.appendChild(d);
            });
        }

        function handleTicker(data) {
            el('high').innerText = parseFloat(data.h).toFixed(2);
            el('low').innerText = parseFloat(data.l).toFixed(2);
            el('vol').innerText = Math.floor(data.v);
            const chg = parseFloat(data.P);
            el('chg').innerText = chg.toFixed(2) + "%";
            el('chg').style.color = chg >= 0 ? 'var(--green)' : 'var(--red)';
        }

        function handleMarkPrice(data) {
            // Funding Rate (r) est en d√©cimal (ex: 0.0001 = 0.01%)
            const rate = parseFloat(data.r) * 100;
            el('funding-rate').innerText = rate.toFixed(4) + "%";
            el('funding-rate').style.color = rate > 0 ? 'var(--green)' : 'var(--red)';
        }

        // --- 4. GLOBAL TICKER ---
        function startGlobalTicker() {
            tickerWs = new WebSocket('wss://stream.binance.com:9443/ws/!miniTicker@arr');
            tickerWs.onmessage = (evt) => {
                const data = JSON.parse(evt.data);
                const tops = data.filter(c => c.s.endsWith('USDT')).sort((a,b) => parseFloat(b.q)-parseFloat(a.q)).slice(0, 15);
                let html = '';
                tops.forEach(c => {
                    const chg = parseFloat(c.P).toFixed(2);
                    const col = chg >= 0 ? 'var(--green)' : 'var(--red)';
                    html += `<span class="tick-item" onclick="changePair('${c.s}')">${c.s.replace('USDT','')} <span style="color:${col}">${parseFloat(c.c).toFixed(2)}</span></span>`;
                });
                el('global-ticker').innerHTML = html;
            };
        }

        // --- 5. WIDGETS ---
        function loadTv() {
            el('tv-container').innerHTML = '';
            new TradingView.widget({
                "autosize": true, "symbol": "BINANCE:" + currentPair.toUpperCase(), "interval": currentTimeframe,
                "timezone": "Etc/UTC", "theme": "dark", "style": "1", "locale": "fr", "toolbar_bg": "#000",
                "enable_publishing": false, "container_id": "tv-container", "hide_side_toolbar": false,
                "overrides": { "paneProperties.background": "#000000", "paneProperties.vertGridProperties.color": "#111", "paneProperties.horzGridProperties.color": "#111" }
            });
        }
        function loadMiniGauge() {
            // Petite jauge pour le panel bas droit
            el('mini-gauge').innerHTML = '';
            const s = document.createElement('script');
            s.src = "https://s3.tradingview.com/external-embedding/embed-widget-technical-analysis.js";
            s.async = true;
            s.innerHTML = JSON.stringify({
                "interval": "1m", "width": "100%", "isTransparent": true, "height": "100%",
                "symbol": "BINANCE:" + currentPair.toUpperCase(), "showIntervalTabs": false, "locale": "fr", "colorTheme": "dark"
            });
            el('mini-gauge').appendChild(s);
        }

        // --- UTILS ---
        function initWatchlist() {
            const favs = ['BTCUSDT','ETHUSDT','SOLUSDT','BNBUSDT','XRPUSDT','DOGEUSDT'];
            el('watchlist').innerHTML = '';
            favs.forEach(p => {
                const d = document.createElement('div');
                d.className = 'row watchlist-item';
                d.style.cursor = 'pointer';
                d.innerHTML = `<span style="font-weight:bold">${p.replace('USDT','')}</span><span>USDT</span>`;
                d.onclick = () => changePair(p);
                el('watchlist').appendChild(d);
            });
        }

        function changePair(p) {
            currentPair = p.toLowerCase();
            el('current-pair-disp').innerText = p.toUpperCase();
            startStream(currentPair);
            loadTv();
            loadMiniGauge();
        }
        function changeTf(tf) { currentTimeframe = tf; loadTv(); }
        function setTab(tab) {
             if(tab === 'chart') { el('tv-container').classList.remove('hidden'); el('gauge-container').classList.add('hidden'); }
             if(tab === 'depth') { alert("View already integrated in left panel"); } // Simplified for this demo
             if(tab === 'news') { alert("News Feed: Coming in v9"); }
        }
        function toggleFs() { !document.fullscreenElement ? document.documentElement.requestFullscreen() : document.exitFullscreen(); }

        // INPUT COMMAND
        el('cmd-input').addEventListener('keypress', e => {
            if (e.key === 'Enter') {
                const val = e.target.value.trim().toLowerCase();
                if(val) changePair(val.endsWith('usdt') ? val : val + 'usdt');
                e.target.value = '';
            }
        });

        // BOOT
        initWatchlist();
        startGlobalTicker();
        startStream(currentPair);
        loadTv();
        loadMiniGauge();

    </script>
</body>
</html>
