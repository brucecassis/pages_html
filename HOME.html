<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLOOMBERG ENS® - ANALYTICS SUITE v11</title>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    
    <style>
        :root { --bg: #000; --amber: #ffaa00; --dim: #666; --green: #0f0; --red: #f00; --liq: #d900ff; --border: #333; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Courier New', monospace; user-select: none; }
        
        /* SCROLL & LAYOUT */
        body { background: var(--bg); color: var(--amber); height: 100vh; display: flex; flex-direction: column; overflow-y: auto; font-size: 10px; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: #111; }

        /* HEADER */
        .ticker-wrap { background: #111; border-bottom: 1px solid var(--amber); white-space: nowrap; overflow: hidden; padding: 2px 0; flex-shrink: 0; }
        .ticker { display: inline-block; animation: ticker 45s linear infinite; }
        @keyframes ticker { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .tick-item { margin-right: 20px; font-weight: bold; cursor: pointer; }

        .header { background: var(--amber); color: #000; padding: 4px 10px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .header-badge { background: #000; color: var(--amber); padding: 1px 6px; border: 1px solid #000; font-size: 9px; }

        /* MAIN GRID (TOP) */
        .main-grid { display: grid; grid-template-columns: 240px 1fr 280px; height: 60vh; min-height: 400px; gap: 1px; background: var(--border); border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .panel { background: var(--bg); display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .title { background: #111; padding: 3px 5px; border-bottom: 1px solid var(--border); color: var(--dim); font-weight: bold; display: flex; justify-content: space-between; font-size: 9px; }

        /* ANALYTICS GRID (BOTTOM) - NEW */
        .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; height: 35vh; min-height: 250px; gap: 1px; background: var(--border); flex-shrink: 0; }

        /* TABS */
        .tabs-bar { grid-column: span 3; background: #000; display: flex; align-items: center; border-bottom: 1px solid var(--border); padding: 0 10px; }
        .tab-btn { background: #111; border: 1px solid #333; color: #666; padding: 3px 10px; cursor: pointer; margin-right: 2px; }
        .tab-btn.active { background: var(--amber); color: #000; font-weight: bold; }

        /* TRADING PANEL */
        .trade-panel { padding: 10px; border-bottom: 1px solid #333; display: flex; flex-direction: column; gap: 6px; }
        .t-input { background: #111; border: 1px solid #333; color: #fff; width: 100%; text-align: right; padding: 4px; }
        .btn-row { display: flex; gap: 5px; }
        .btn-trade { flex: 1; padding: 5px; border: none; cursor: pointer; font-weight: bold; color: #000; }
        .btn-buy { background: var(--green); } .btn-sell { background: var(--red); }

        /* LISTS (Tape, Book, News) */
        .list { overflow-y: auto; flex-grow: 1; }
        .row { display: flex; justify-content: space-between; padding: 1px 6px; border-bottom: 1px solid #080808; }
        .news-item { padding: 6px 5px; border-bottom: 1px solid #222; cursor: pointer; line-height: 1.2; }
        .news-item:hover { background: #111; color: #fff; }
        .whale { color: var(--amber); font-weight: bold; background: rgba(255, 170, 0, 0.15); }

        /* CHARTS CONTAINERS */
        #tv-container, #oi-chart, #liq-chart { width: 100%; height: 100%; }
        
        .hidden { display: none !important; }
        .g { color: var(--green); } .r { color: var(--red); }
    </style>
</head>
<body>

    <div class="ticker-wrap"><div class="ticker" id="global-ticker">INITIALIZING DATA...</div></div>

    <div class="header">
        <span>BLOOMBERG ENS v11 [ANALYTICS]</span>
        <div style="display:flex; gap:10px;">
            <span class="header-badge">OI: <span id="oi-header">--</span></span>
            <span class="header-badge">FUNDING: <span id="fund-header">--</span></span>
            <span id="clock">--:--:--</span>
        </div>
    </div>

    <div class="main-grid">
        <div class="tabs-bar">
            <span style="color:var(--amber); font-weight:bold; margin-right:15px;" id="pair-disp">BTCUSDT</span>
            <button class="tab-btn active" onclick="setLeftTab('trade')">TRADING</button>
            <button class="tab-btn" onclick="setLeftTab('news')">NEWS WIRE</button>
            <div style="flex-grow:1"></div>
            <button class="tab-btn" onclick="setTf('1')">1m</button>
            <button class="tab-btn" onclick="setTf('15')">15m</button>
            <button class="tab-btn" onclick="setTf('60')">1H</button>
        </div>

        <div class="panel" style="grid-row: span 2;">
            <div id="tab-trade">
                <div class="title"><span style="color:var(--green)">PAPER TRADING</span><span>WALLET</span></div>
                <div class="trade-panel">
                    <div style="display:flex; justify-content:space-between; color:#888;">
                        <span>EQUITY</span><span id="wallet-bal" style="color:#fff; font-weight:bold">--</span>
                    </div>
                    <input type="number" id="trade-size" class="t-input" placeholder="SIZE (USD)" value="1000">
                    <div class="btn-row">
                        <button class="btn-trade btn-buy" onclick="trade('long')">BUY</button>
                        <button class="btn-trade btn-sell" onclick="trade('short')">SELL</button>
                    </div>
                    <div id="pos-box" style="display:none; background:#111; padding:5px; margin-top:5px;">
                        <div style="display:flex; justify-content:space-between;">
                            <span id="pos-side">LONG</span><span id="pos-pnl">--</span>
                        </div>
                        <button onclick="closePos()" style="width:100%; background:#333; color:#fff; border:none; margin-top:5px; cursor:pointer;">CLOSE</button>
                    </div>
                </div>
                <div class="title"><span>ORDER BOOK</span><span>DEPTH</span></div>
                <div class="list">
                    <div id="asks" style="display:flex; flex-direction:column-reverse;"></div>
                    <div id="spread" style="text-align:center; color:#444; border-y:1px solid #222;">-</div>
                    <div id="bids"></div>
                </div>
            </div>
            <div id="tab-news" class="hidden list">
                <div style="padding:10px;text-align:center">LOADING NEWS...</div>
            </div>
        </div>

        <div class="panel" style="grid-row: span 2;">
            <div id="tv-container"></div>
        </div>

        <div class="panel" style="grid-row: span 2;">
            <div class="title"><span>TAPE & WHALES</span><span>LIVE</span></div>
            <div id="tape" class="list"></div>
        </div>
    </div>

    <div class="analytics-grid">
        <div class="panel">
            <div class="title"><span>OPEN INTEREST HISTORY</span><span>FUTURES</span></div>
            <div id="oi-chart"></div>
        </div>
        <div class="panel">
            <div class="title"><span style="color:var(--liq)">LIQUIDATION MONITOR</span><span>REKT VOL</span></div>
            <div id="liq-chart"></div>
        </div>
    </div>

    <div style="background:#111; padding:4px 10px; border-top:1px solid #333; display:flex; justify-content:space-between; flex-shrink:0;">
        <div><span style="color:var(--green)">● ONLINE</span> | <span id="ping">PING: --ms</span></div>
        <input id="cmd" type="text" style="background:#000; border:1px solid #333; color:var(--amber); width:100px; text-align:center;" placeholder="CMD">
    </div>

    <script>
        // CONFIG
        let currentPair = 'btcusdt';
        let wallet = 10000, position = null;
        let wsSpot, wsFut;
        
        // CHARTS VARS
        let oiChart, oiSeries;
        let liqChart, liqSeries;
        let liqDataMap = {}; // Aggregate liqs per second

        const el = id => document.getElementById(id);
        
        // --- 1. INIT BOTTOM CHARTS ---
        function initAnalyticsCharts() {
            // OI Chart
            oiChart = LightweightCharts.createChart(el('oi-chart'), {
                layout: { background: { color: '#000' }, textColor: '#d1d4dc' },
                grid: { vertLines: { color: '#111' }, horzLines: { color: '#111' } },
                timeScale: { timeVisible: true, secondsVisible: true },
                rightPriceScale: { scaleMargins: { top: 0.1, bottom: 0.1 } }
            });
            oiSeries = oiChart.addLineSeries({ color: '#ffaa00', lineWidth: 2 });

            // Liq Chart (Histogram)
            liqChart = LightweightCharts.createChart(el('liq-chart'), {
                layout: { background: { color: '#000' }, textColor: '#d1d4dc' },
                grid: { vertLines: { color: '#111' }, horzLines: { color: '#111' } },
                timeScale: { timeVisible: true, secondsVisible: true }
            });
            liqSeries = liqChart.addHistogramSeries({ color: '#26a69a' });
            
            // Auto resize
            window.addEventListener('resize', () => {
                // Manually resize charts if needed, or rely on container
            });
        }

        // --- 2. DATA STREAMS ---
        function startStreams(pair) {
            if(wsSpot) wsSpot.close();
            if(wsFut) wsFut.close();
            
            // Reset Chart Data
            if(oiSeries) oiSeries.setData([]);
            if(liqSeries) liqSeries.setData([]);

            // SPOT WS
            wsSpot = new WebSocket(`wss://stream.binance.com:9443/stream?streams=${pair}@depth10/${pair}@trade`);
            wsSpot.onmessage = e => {
                const msg = JSON.parse(e.data);
                if(msg.stream.includes('trade')) handleTrade(msg.data);
                if(msg.stream.includes('depth')) handleDepth(msg.data);
            };

            // FUTURES WS (Liq + AggTrade pour simuler OI live)
            wsFut = new WebSocket(`wss://fstream.binance.com/stream?streams=${pair}@forceOrder/${pair}@aggTrade`);
            wsFut.onmessage = e => {
                const msg = JSON.parse(e.data);
                if(msg.stream.includes('forceOrder')) handleLiq(msg.data);
                if(msg.stream.includes('aggTrade')) handleFutTrade(msg.data); // Update OI visual
            };

            // Fetch News & Base OI
            loadNews();
            updateOI(pair);
            setInterval(() => updateOI(pair), 15000); // Polling OI API
        }

        // --- 3. HANDLERS ---
        
        // Handle Liquidations (Graphique)
        function handleLiq(d) {
            const o = d.o;
            const vol = parseFloat(o.q) * parseFloat(o.p); // USD Volume
            const time = Math.floor(Date.now() / 1000);
            
            // Bar Color: Green if Short Rekt (Buy), Red if Long Rekt (Sell)
            const color = o.S === 'SELL' ? '#ff0000' : '#00ff00'; 
            
            // Update Histogram
            liqSeries.update({ time: time, value: vol, color: color });
            
            // Flash Tape
            const row = document.createElement('div');
            row.className = 'row';
            row.style.borderLeft = `3px solid ${color}`;
            row.innerHTML = `<span style="color:#d900ff; font-weight:bold">LIQ ${o.S==='SELL'?'LONG':'SHORT'}</span><span style="color:#fff">${vol.toFixed(0)}$</span>`;
            el('tape').prepend(row);
        }

        // Handle OI
        async function updateOI(pair) {
            try {
                // Binance Futures API for Open Interest
                const res = await fetch(`https://fapi.binance.com/fapi/v1/openInterest?symbol=${pair.toUpperCase()}`);
                const data = await res.json();
                const oiVal = parseFloat(data.openInterest);
                
                // Update UI Header
                el('oi-header').innerText = (oiVal).toFixed(2);
                
                // Update Chart
                const time = Math.floor(Date.now() / 1000);
                oiSeries.update({ time: time, value: oiVal });
                
                // Funding
                const resF = await fetch(`https://fapi.binance.com/fapi/v1/premiumIndex?symbol=${pair.toUpperCase()}`);
                const dataF = await resF.json();
                el('fund-header').innerText = (parseFloat(dataF.lastFundingRate)*100).toFixed(4) + "%";
            } catch(e) {}
        }
        
        // Simuler update OI entre les appels API (pour l'animation)
        function handleFutTrade(d) {
           // On ne peut pas calculer l'OI exact via WS sans API, donc on attend le poll
           // Mais on pourrait ajouter du bruit ici pour rendre le graph vivant
        }

        // Handle News (CryptoCompare)
        async function loadNews() {
            const c = el('tab-news');
            c.innerHTML = '<div style="padding:5px">UPDATING...</div>';
            try {
                const res = await fetch('https://min-api.cryptocompare.com/data/v2/news/?lang=EN');
                const d = await res.json();
                c.innerHTML = '';
                d.Data.slice(0, 15).forEach(n => {
                    const div = document.createElement('div');
                    div.className = 'news-item';
                    div.innerHTML = `<div style="font-size:8px; color:#555">${new Date(n.published_on*1000).toLocaleTimeString()}</div><div>${n.title}</div>`;
                    div.onclick = () => window.open(n.url, '_blank');
                    c.appendChild(div);
                });
            } catch(e) { c.innerHTML = 'NEWS ERROR'; }
        }

        function handleTrade(d) {
            const p = parseFloat(d.p);
            const q = parseFloat(d.q);
            const row = document.createElement('div');
            row.className = 'row';
            if(p*q > 50000) row.classList.add('whale');
            row.innerHTML = `<span style="color:#666">${new Date(d.T).toLocaleTimeString().split(' ')[0]}</span><span class="${d.m?'r':'g'}">${p.toFixed(2)}</span><span>${q.toFixed(4)}</span>`;
            el('tape').prepend(row);
            if(el('tape').children.length > 30) el('tape').lastChild.remove();
            
            // Update Paper Trading PnL
            if(position) {
                const diff = position.side==='long' ? (p - position.entry) : (position.entry - p);
                const pnl = diff * position.amt;
                el('pos-pnl').innerText = pnl.toFixed(2);
                el('pos-pnl').style.color = pnl>=0?'#0f0':'#f00';
            }
        }

        function handleDepth(d) {
            renderList(d.asks, el('asks'), 'r', true);
            renderList(d.bids, el('bids'), 'g', false);
            el('spread').innerText = (parseFloat(d.asks[0][0]) - parseFloat(d.bids[0][0])).toFixed(2);
        }
        function renderList(l, c, col, rev) {
            c.innerHTML = '';
            (rev?l.slice(0,8).reverse():l.slice(0,8)).forEach(i=>c.innerHTML+=`<div class="row"><span class="${col}">${parseFloat(i[0]).toFixed(2)}</span><span>${parseFloat(i[1]).toFixed(4)}</span></div>`);
        }

        // --- 4. WIDGETS ---
        function loadTv(pair) {
            el('tv-container').innerHTML = '';
            new TradingView.widget({
                "autosize": true, "symbol": "BINANCE:"+pair.toUpperCase(), "interval": "1",
                "timezone": "Etc/UTC", "theme": "dark", "style": "1", "locale": "fr", "toolbar_bg": "#000",
                "enable_publishing": false, "hide_side_toolbar": false, "container_id": "tv-container",
                "overrides": { "paneProperties.background": "#000" }
            });
        }

        // --- 5. SYSTEM ---
        function trade(side) {
            const p = parseFloat(document.querySelector('.g').innerText);
            const s = parseFloat(el('trade-size').value);
            if(!p) return;
            wallet -= s*0.001;
            position = { side, entry: p, size: s, amt: s/p };
            updateWallet(); saveData();
        }
        function closePos() {
            if(!position) return;
            const p = parseFloat(document.querySelector('.g').innerText);
            const diff = position.side==='long' ? (p - position.entry) : (position.entry - p);
            wallet += diff * position.amt;
            position = null;
            updateWallet(); saveData();
        }
        function updateWallet() {
            el('wallet-bal').innerText = "$"+wallet.toFixed(2);
            el('pos-box').style.display = position ? 'block' : 'none';
            if(position) el('pos-side').innerText = position.side.toUpperCase();
        }
        function loadData() {
            const d = JSON.parse(localStorage.getItem('bloomberg_v11')||'{}');
            if(d.w) wallet = d.w;
            updateWallet();
        }
        function saveData() { localStorage.setItem('bloomberg_v11', JSON.stringify({w:wallet})); }
        function setLeftTab(t) {
            if(t==='trade') { el('tab-trade').classList.remove('hidden'); el('tab-news').classList.add('hidden'); }
            if(t==='news') { el('tab-trade').classList.add('hidden'); el('tab-news').classList.remove('hidden'); }
        }

        // BOOT
        initAnalyticsCharts();
        startStreams(currentPair);
        loadTv(currentPair);
        loadData();
        setInterval(() => el('clock').innerText = new Date().toISOString().split('T')[1].split('.')[0], 1000);
        
        // Ticker Line
        const wsTicker = new WebSocket('wss://stream.binance.com:9443/ws/!miniTicker@arr');
        wsTicker.onmessage = e => {
             const d = JSON.parse(e.data).filter(x=>x.s.endsWith('USDT')).sort((a,b)=>parseFloat(b.q)-parseFloat(a.q)).slice(0,15);
             el('global-ticker').innerHTML = d.map(x=>`<span class="tick-item" onclick="changePair('${x.s}')">${x.s.replace('USDT','')} <span style="color:${x.P>0?'#0f0':'#f00'}">${parseFloat(x.c).toFixed(2)}</span></span>`).join('');
        };
        
        function changePair(p) {
            currentPair = p.toLowerCase();
            el('pair-disp').innerText = p.toUpperCase();
            startStreams(currentPair);
            loadTv(currentPair);
        }
        
        el('cmd').addEventListener('keypress', e=>{
            if(e.key==='Enter') { changePair(e.target.value.toLowerCase().endsWith('usdt')?e.target.value:e.target.value+'usdt'); e.target.value=''; }
        });

    </script>
</body>
</html>
