<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLOOMBERG ENS® - LIVE TERMINAL</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            --bg-color: #000000;
            --panel-bg: #0a0a0a;
            --border: #333333;
            --text-main: #ffaa00; /* Bloomberg Amber */
            --text-dim: #666666;
            --up-color: #00ff00;
            --down-color: #ff0000;
            --font-stack: 'Courier New', 'Consolas', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-stack);
            font-size: 11px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- HEADER & COMMAND --- */
        .top-bar {
            background: var(--text-main);
            color: #000;
            padding: 4px 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }
        
        .cmd-line {
            background: #111;
            border-bottom: 1px solid var(--text-main);
            padding: 5px 10px;
            display: flex;
            align-items: center;
        }
        .cmd-input {
            background: transparent;
            border: none;
            color: var(--text-main);
            font-family: inherit;
            margin-left: 10px;
            width: 300px;
            text-transform: uppercase;
            outline: none;
        }

        /* --- LAYOUT GRID --- */
        .grid-container {
            display: grid;
            grid-template-columns: 280px 1fr 280px; /* Gauche - Centre - Droite */
            grid-template-rows: 1fr 180px; /* Haut - Bas */
            gap: 1px;
            background-color: var(--border); /* Crée les bordures entre les panels */
            flex-grow: 1;
        }

        .panel {
            background-color: var(--bg-color);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            background: #111;
            padding: 3px 8px;
            border-bottom: 1px solid var(--border);
            font-weight: bold;
            color: var(--text-dim);
            font-size: 10px;
            display: flex;
            justify-content: space-between;
        }

        /* --- COMPONENTS --- */
        
        /* Order Book */
        .order-book { overflow-y: hidden; flex-grow: 1; font-size: 10px; }
        .ob-row { display: flex; justify-content: space-between; padding: 1px 8px; position: relative; }
        .ob-bg { position: absolute; top: 0; bottom: 0; right: 0; opacity: 0.2; z-index: 0; }
        .ob-ask .ob-bg { background: var(--down-color); }
        .ob-bid .ob-bg { background: var(--up-color); }
        .ob-val { z-index: 1; position: relative; }
        .ask-text { color: var(--down-color); }
        .bid-text { color: var(--up-color); }

        /* Chart Container */
        #chart-container { width: 100%; height: 100%; }

        /* Ticker Tape (Trades) */
        .tape-list { overflow: hidden; }
        .trade-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 2px 8px; 
            border-bottom: 1px solid #111;
        }
        .trade-buy { color: var(--up-color); }
        .trade-sell { color: var(--down-color); }

        /* Stats Panel */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            padding: 10px;
            gap: 15px;
        }
        .stat-box { border: 1px solid var(--border); padding: 5px; }
        .stat-label { color: var(--text-dim); font-size: 9px; margin-bottom: 2px; }
        .stat-value { font-size: 14px; font-weight: bold; }

        /* Footer */
        .footer {
            background: #111;
            padding: 4px 10px;
            color: var(--text-dim);
            font-size: 9px;
            display: flex;
            justify-content: space-between;
            border-top: 1px solid var(--border);
        }
        .connection-status { color: var(--up-color); }

        /* Blinking effect */
        @keyframes flash { 0% { background: #333; } 100% { background: transparent; } }
        .flash { animation: flash 0.5s; }

    </style>
</head>
<body>

    <div class="top-bar">
        <span>BLOOMBERG ENS TERMINAL</span>
        <span id="clock">--:--:-- UTC</span>
    </div>
    <div class="cmd-line">
        <span>COMMAND ></span>
        <input type="text" class="cmd-input" value="BTCUSDT" id="pair-input" placeholder="ENTER PAIR...">
        <span style="color:var(--text-dim)">[PRESS ENTER TO LOAD]</span>
    </div>

    <div class="grid-container">
        
        <div class="panel" style="grid-row: span 2;">
            <div class="panel-header">
                <span>ORDER BOOK (DEPTH)</span>
                <span>BTC/USDT</span>
            </div>
            <div style="display:flex; justify-content:space-between; padding:4px 8px; color:var(--text-dim); font-size:9px;">
                <span>PRICE</span><span>SIZE</span>
            </div>
            <div id="asks-container" class="order-book" style="border-bottom:1px solid var(--border);"></div>
            <div id="spread-display" style="text-align:center; padding:2px; color:var(--text-dim);">SPREAD: --</div>
            <div id="bids-container" class="order-book"></div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <span>CHART: LIVE FEED (1M)</span>
                <span id="current-price-header" style="font-size:12px; color: var(--text-main);">LOADING...</span>
            </div>
            <div id="chart-container"></div>
        </div>

        <div class="panel" style="grid-row: span 2;">
            <div class="panel-header">
                <span>TAPE (REAL-TIME TRADES)</span>
                <span>VOL</span>
            </div>
            <div id="tape-container" class="tape-list">
                </div>
        </div>

        <div class="panel">
            <div class="panel-header">MARKET INTELLIGENCE</div>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">FEAR & GREED</div>
                    <div class="stat-value" id="fng-value">--</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">24H VOL (BTC)</div>
                    <div class="stat-value" id="vol-value">--</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">24H HIGH</div>
                    <div class="stat-value" id="high-value">--</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">ETH GAS (EST)</div>
                    <div class="stat-value" id="gas-value">~15 Gwei</div>
                </div>
            </div>
        </div>

    </div>

    <div class="footer">
        <div>SYSTEM STATUS: <span class="connection-status">● STREAMING DATA</span></div>
        <div>DATA SOURCE: BINANCE PUBLIC API • ALTERNATIVE.ME</div>
    </div>

    <script>
        // --- CONFIGURATION ---
        let currentPair = 'btcusdt';
        let ws = null;
        let chart, candleSeries;

        // --- GESTION DES ERREURS VISUELLES ---
        function logStatus(msg, type = 'normal') {
            const el = document.getElementById('current-price-header');
            el.innerText = msg;
            if(type === 'error') el.style.color = 'red';
            else el.style.color = '#ffaa00';
            console.log(msg);
        }

        // --- 1. HORLOGE (Indépendante) ---
        function updateClock() {
            const now = new Date();
            const timeString = now.toISOString().split('T')[1].split('.')[0] + ' UTC';
            document.getElementById('clock').innerText = timeString;
        }
        // On lance l'horloge tout de suite, sans attendre les données
        setInterval(updateClock, 1000);
        updateClock();

        // --- 2. INITIALISATION CHART ---
        function initChart() {
            try {
                const chartContainer = document.getElementById('chart-container');
                chart = LightweightCharts.createChart(chartContainer, {
                    layout: { background: { color: '#000000' }, textColor: '#ffaa00' },
                    grid: { vertLines: { color: '#111' }, horzLines: { color: '#111' } },
                    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                    rightPriceScale: { borderColor: '#333', scaleMargins: { top: 0.1, bottom: 0.1 } },
                    timeScale: { borderColor: '#333', timeVisible: true, secondsVisible: false },
                });

                candleSeries = chart.addCandlestickSeries({
                    upColor: '#00ff00', downColor: '#ff0000',
                    borderVisible: false, wickUpColor: '#00ff00', wickDownColor: '#ff0000',
                });
                
                new ResizeObserver(entries => {
                    if (entries.length === 0 || entries[0].target !== chartContainer) return;
                    const newRect = entries[0].contentRect;
                    chart.applyOptions({ width: newRect.width, height: newRect.height });
                }).observe(chartContainer);
            } catch (e) {
                logStatus("ERREUR CHART: " + e.message, 'error');
            }
        }

        // --- 3. WEBSOCKET (Données en direct) ---
        function connectWebSocket(pair) {
            if (ws) ws.close();
            
            logStatus("CONNEXION BINANCE...", 'normal');

            const streams = [`${pair}@kline_1m`, `${pair}@depth20`, `${pair}@trade`].join('/');
            ws = new WebSocket(`wss://stream.binance.com:9443/stream?streams=${streams}`);

            ws.onopen = () => {
                logStatus("CONNEXION ÉTABLIE - FLUX EN DIRECT", 'normal');
                document.querySelector('.connection-status').style.color = '#00ff00';
            };
            
            ws.onerror = (e) => {
                logStatus("ERREUR WEBSOCKET (BLOQUÉ?)", 'error');
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                const data = message.data;
                const type = message.stream.split('@')[1];

                if (type === 'kline_1m') {
                    const k = data.k;
                    candleSeries.update({
                        time: k.t / 1000, open: parseFloat(k.o), high: parseFloat(k.h), low: parseFloat(k.l), close: parseFloat(k.c)
                    });
                    document.getElementById('current-price-header').innerText = `BTC/USDT: ${parseFloat(k.c).toFixed(2)}`;
                    document.getElementById('vol-value').innerText = Math.floor(parseFloat(k.v));
                    document.getElementById('high-value').innerText = parseFloat(k.h).toFixed(2);
                }
                if (type === 'depth20') handleDepth(data);
                if (type === 'trade') handleTrade(data);
            };
        }

        function handleDepth(data) {
            const asksContainer = document.getElementById('asks-container');
            const bidsContainer = document.getElementById('bids-container');
            asksContainer.innerHTML = ''; 
            bidsContainer.innerHTML = '';

            // On affiche seulement les 8 premiers pour éviter de surcharger le DOM si ça lag
            data.asks.slice(0, 8).reverse().forEach(ask => asksContainer.appendChild(createOrderRow(ask, 'ob-ask')));
            data.bids.slice(0, 8).forEach(bid => bidsContainer.appendChild(createOrderRow(bid, 'ob-bid')));
            
            const spread = (parseFloat(data.asks[0][0]) - parseFloat(data.bids[0][0])).toFixed(2);
            document.getElementById('spread-display').innerText = `SPREAD: ${spread}`;
        }

        function createOrderRow(item, type) {
            const price = parseFloat(item[0]).toFixed(2);
            const size = parseFloat(item[1]).toFixed(4);
            const width = Math.min(size * 10, 100);
            const div = document.createElement('div');
            div.className = `ob-row ${type}`;
            div.innerHTML = `<div class="ob-bg" style="width:${width}%"></div><span class="ob-val ${type==='ob-ask'?'ask-text':'bid-text'}">${price}</span><span class="ob-val" style="color:#666">${size}</span>`;
            return div;
        }

        function handleTrade(data) {
            const container = document.getElementById('tape-container');
            const row = document.createElement('div');
            row.className = 'trade-item';
            row.innerHTML = `<span style="color:#555">${new Date(data.T).toLocaleTimeString()}</span><span class="${data.m ? 'trade-sell' : 'trade-buy'}">${parseFloat(data.p).toFixed(2)}</span><span style="color:#888">${parseFloat(data.q).toFixed(5)}</span>`;
            container.prepend(row);
            if (container.children.length > 25) container.lastChild.remove();
        }

        // --- 4. DATA INITIALE (REST API) ---
        async function fetchHistory(pair) {
            try {
                // On essaie de récupérer l'historique
                const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${pair.toUpperCase()}&interval=1m&limit=200`);
                if (!res.ok) throw new Error("API Limit/Error");
                const data = await res.json();
                const candles = data.map(d => ({
                    time: d[0] / 1000, open: parseFloat(d[1]), high: parseFloat(d[2]), low: parseFloat(d[3]), close: parseFloat(d[4])
                }));
                candleSeries.setData(candles);
            } catch (e) {
                console.log("Impossible de charger l'historique (CORS probable), passage au WebSocket direct.");
                // Pas grave, le websocket va remplir le graph petit à petit
            }
        }

        // --- START ---
        initChart();
        fetchHistory(currentPair).then(() => connectWebSocket(currentPair));
        
        // Commande Input
        document.getElementById('pair-input').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') {
                currentPair = e.target.value.toLowerCase().trim();
                connectWebSocket(currentPair);
                fetchHistory(currentPair);
            }
        });
    </script>
