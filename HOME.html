<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLOOMBERG ENS® - HYBRID TERMINAL</title>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <style>
        :root { --bg: #000; --amber: #ffaa00; --dim: #666; --green: #0f0; --red: #f00; --border: #333; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Courier New', monospace; }
        body { background: var(--bg); color: var(--amber); height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-size: 11px; }

        /* HEADER & CMD */
        .header { background: var(--amber); color: #000; padding: 4px 10px; font-weight: bold; display: flex; justify-content: space-between; }
        .cmd { background: #111; border-bottom: 1px solid var(--amber); padding: 5px; display: flex; align-items: center; }
        .cmd input { background: transparent; border: none; color: var(--amber); width: 200px; margin-left: 10px; text-transform: uppercase; font-weight: bold; outline: none; }
        
        /* GRID LAYOUT */
        .grid { display: grid; grid-template-columns: 280px 1fr 280px; grid-template-rows: 1fr 180px; gap: 1px; background: var(--border); flex-grow: 1; }
        .panel { background: var(--bg); display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .title { background: #111; padding: 4px; border-bottom: 1px solid var(--border); color: var(--dim); font-weight: bold; display: flex; justify-content: space-between; }
        
        /* LISTS (TAPE & BOOK) */
        .list { overflow: hidden; flex-grow: 1; }
        .row { display: flex; justify-content: space-between; padding: 1px 5px; }
        .g { color: var(--green); } .r { color: var(--red); }

        /* TRADINGVIEW CONTAINER */
        #tv-container { width: 100%; height: 100%; }
        
        /* STATS */
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 10px; }
        .box { border: 1px solid var(--border); padding: 5px; }
        .val { font-size: 13px; font-weight: bold; }
        .foot { background: #111; border-top: 1px solid #333; padding: 5px; color: var(--dim); display: flex; justify-content: space-between; }
    </style>
</head>
<body>

    <div class="header">
        <span>BLOOMBERG ENS TERMINAL</span>
        <span id="time">--:--:-- UTC</span>
    </div>
    
    <div class="cmd">
        <span>COMMAND ></span>
        <input type="text" id="pair" value="BTCUSDT" placeholder="ENTER PAIR...">
        <span>[ENTER]</span>
    </div>

    <div class="grid">
        <div class="panel" style="grid-row: span 2;">
            <div class="title"><span>ORDER BOOK</span><span>DEPTH</span></div>
            <div class="list">
                <div id="asks" style="display:flex; flex-direction:column-reverse;"></div>
                <div id="spread" style="text-align:center; color:#444; padding:2px;">---</div>
                <div id="bids"></div>
            </div>
        </div>

        <div class="panel">
            <div class="title">
                <span>CHART (TRADINGVIEW)</span>
                <span style="color:var(--amber)">LIVE FEED</span>
            </div>
            <div id="tv-container"></div>
        </div>

        <div class="panel" style="grid-row: span 2;">
            <div class="title"><span>TAPE</span><span>TRADES</span></div>
            <div id="tape" class="list"></div>
        </div>

        <div class="panel">
            <div class="title">MARKET DATA (24H)</div>
            <div class="stats">
                <div class="box"><div class="val" id="high">--</div></div>
                <div class="box"><div class="val" id="low">--</div></div>
                <div class="box"><div class="val" id="vol">--</div></div>
                <div class="box"><div class="val" id="chg">--</div></div>
            </div>
        </div>
    </div>

    <div class="foot">
        <div id="status">● SYSTEM READY</div>
        <div>BINANCE WSS • TV WIDGET</div>
    </div>

    <script>
        // CONFIG
        let ws = null;
        let currentPair = 'btcusdt';
        const el = id => document.getElementById(id);
        const log = msg => el('status').innerText = "● " + msg;

        // HORLOGE
        setInterval(() => el('time').innerText = new Date().toISOString().split('T')[1].split('.')[0] + ' UTC', 1000);

        // 1. INITIALISER TRADINGVIEW
        function loadTvWidget(pair) {
            // Nettoyage conteneur
            el('tv-container').innerHTML = "";
            
            new TradingView.widget({
                "autosize": true,
                "symbol": "BINANCE:" + pair.toUpperCase(),
                "interval": "1",
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "1",
                "locale": "fr",
                "toolbar_bg": "#000000",
                "enable_publishing": false,
                "hide_top_toolbar": false,
                "hide_side_toolbar": false,
                "allow_symbol_change": false, // On force l'utilisateur à utiliser notre barre de commande
                "container_id": "tv-container",
                "overrides": {
                    "paneProperties.background": "#000000",
                    "paneProperties.vertGridProperties.color": "#111",
                    "paneProperties.horzGridProperties.color": "#111",
                }
            });
        }

        // 2. WEBSOCKET (Données annexes : Tape, Book, Stats)
        function startStream(pair) {
            if (ws) ws.close();
            log("SYNCING DATA...");
            
            // On retire le flux 'kline' car TradingView s'en occupe
            const streams = [`${pair}@depth10`, `${pair}@trade`, `${pair}@ticker`].join('/');
            ws = new WebSocket(`wss://stream.binance.com:9443/stream?streams=${streams}`);

            ws.onopen = () => { log("STREAM ACTIVE"); el('status').style.color = "#0f0"; };
            ws.onerror = () => { log("CONNECTION ERROR"); el('status').style.color = "#f00"; };

            ws.onmessage = (evt) => {
                const msg = JSON.parse(evt.data);
                const data = msg.data;
                const type = msg.stream.split('@')[1];

                if (type === 'trade') updateTape(data);
                if (type === 'depth10') updateBook(data);
                if (type === 'ticker') updateStats(data);
            };
        }

        // Helpers UI
        function updateTape(data) {
            const row = document.createElement('div');
            row.className = 'row';
            row.innerHTML = `<span style="color:#555">${new Date(data.T).toLocaleTimeString().split(' ')[0]}</span><span class="${data.m?'r':'g'}">${parseFloat(data.p).toFixed(2)}</span><span style="color:#666">${parseFloat(data.q).toFixed(4)}</span>`;
            el('tape').prepend(row);
            if (el('tape').children.length > 20) el('tape').lastChild.remove();
        }

        function updateBook(data) {
            renderList(data.asks, el('asks'), 'r', true);
            renderList(data.bids, el('bids'), 'g', false);
            el('spread').innerText = (parseFloat(data.asks[0][0]) - parseFloat(data.bids[0][0])).toFixed(2);
        }

        function renderList(list, container, color, reverse) {
            container.innerHTML = '';
            const arr = reverse ? list.slice(0,8).reverse() : list.slice(0,8);
            arr.forEach(i => {
                const d = document.createElement('div');
                d.className = 'row';
                d.innerHTML = `<span class="${color}">${parseFloat(i[0]).toFixed(2)}</span><span style="color:#444">${parseFloat(i[1]).toFixed(4)}</span>`;
                container.appendChild(d);
            });
        }

        function updateStats(data) {
            el('high').innerText = parseFloat(data.h).toFixed(2);
            el('low').innerText = parseFloat(data.l).toFixed(2);
            el('vol').innerText = Math.floor(data.v);
            const chg = parseFloat(data.P);
            el('chg').innerHTML = `<span class="${chg>=0?'g':'r'}">${chg.toFixed(2)}%</span>`;
        }

        // --- DEMARRAGE ---
        loadTvWidget(currentPair);
        startStream(currentPair);

        // Gestion Commande
        el('pair').addEventListener('keypress', e => {
            if (e.key === 'Enter') {
                const val = e.target.value.toLowerCase().trim();
                if (val) {
                    currentPair = val;
                    // Mise à jour des deux systèmes
                    loadTvWidget(currentPair);
                    startStream(currentPair);
                }
            }
        });

    </script>
</body>
</html>
