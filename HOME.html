<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLOOMBERG ENS¬Æ - V17 COMPLETE</title>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <style>
        :root { 
            --bg: #050505; 
            --amber: #ffaa00; 
            --dim: #555; 
            --green: #00ff41; 
            --red: #ff3333; 
            --liq: #00d9ff; 
            --border: #222; 
            --panel-bg: #0a0a0a; 
            --blue: #2962ff;
            --purple: #9d00ff;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Consolas', 'Monaco', monospace; user-select: none; }
        body { background: var(--bg); color: var(--amber); height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-size: 11px; }
        
        /* UTILS */
        .hidden { display: none !important; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; }
        ::-webkit-scrollbar-track { background: #000; }
        .pop-toast { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* LAYOUT MAIN */
        .ticker-wrap { background: #080808; border-bottom: 1px solid #333; padding: 2px 0; font-size: 10px; white-space: nowrap; overflow: hidden; }
        .ticker { display: inline-block; animation: ticker 60s linear infinite; }
        @keyframes ticker { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .tick-item { margin-right: 20px; cursor: pointer; color: #666; transition: color 0.2s; } 
        .tick-item:hover { color: var(--amber); }

        .header { background: #111; border-bottom: 1px solid var(--amber); padding: 4px 10px; display: flex; justify-content: space-between; align-items: center; height: 32px; }
        .search-box { display: flex; align-items: center; background: #000; border: 1px solid #333; width: 200px; padding: 0 5px; }
        #symbol-input { background: transparent; border: none; color: #fff; width: 100%; text-transform: uppercase; outline: none; font-weight: bold; }

        .grid { display: grid; grid-template-columns: 260px 1fr 300px; grid-template-rows: 32px 1fr 180px; gap: 1px; background: var(--border); flex-grow: 1; overflow: hidden; }
        .panel { background: var(--panel-bg); display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .title { background: #111; padding: 4px 8px; border-bottom: 1px solid var(--border); color: #888; font-weight: bold; display: flex; justify-content: space-between; font-size: 10px; }

        /* TABS */
        .tabs-bar { grid-column: span 3; background: #080808; display: flex; align-items: center; border-bottom: 1px solid var(--border); padding: 0 5px; gap: 2px; }
        .pair-badge { background: var(--amber); color: #000; font-weight: 900; font-size: 12px; padding: 2px 8px; margin-right: 10px; border-radius: 2px; }
        .tab-btn { background: #151515; border: 1px solid #333; color: #666; padding: 4px 12px; cursor: pointer; font-size: 10px; transition: all 0.2s; }
        .tab-btn:hover { color: #fff; background: #222; }
        .tab-btn.active { border-bottom: 2px solid var(--amber); color: var(--amber); background: #111; font-weight: bold; }
        /* Tab Colors */
        .tab-defi.active { border-color: var(--blue); color: var(--blue); }
        .tab-dex.active { border-color: var(--green); color: var(--green); }
        .tab-eth.active { border-color: #627eea; color: #627eea; }

        /* DATA UI ELEMENTS */
        .sub-nav { display: flex; background: #0a0a0a; border-bottom: 1px solid #222; padding: 5px; gap: 5px; overflow-x: auto; white-space: nowrap; }
        .sub-btn { background: #111; border: 1px solid #333; color: #666; padding: 4px 8px; cursor: pointer; font-size: 9px; flex-shrink: 0; }
        .sub-btn.active { background: #222; color: var(--blue); border-color: var(--blue); font-weight: bold; }
        
        .dex-search-bar { padding: 10px; background: #111; border-bottom: 1px solid #222; display: flex; gap: 5px; }
        .dex-input { background: #000; border: 1px solid #333; color: #fff; flex: 1; padding: 4px; font-family: monospace; }

        /* GRIDS LAYOUTS */
        .defi-row { display: grid; padding: 6px 10px; border-bottom: 1px solid #1a1a1a; align-items: center; cursor: pointer; transition: background 0.1s; }
        .defi-row:hover { background: #151515; }
        .defi-head { background: #111; color: #666; font-weight: bold; border-bottom: 1px solid #333; position: sticky; top: 0; cursor: default; }
        
        .grid-tvl     { grid-template-columns: 20px 1fr 80px 60px; }
        .grid-fees    { grid-template-columns: 20px 1fr 70px 70px; }
        .grid-yield   { grid-template-columns: 1fr 40px 70px 50px 50px; }
        .grid-stables { grid-template-columns: 1fr 80px 80px 60px; }
        .grid-dex     { grid-template-columns: 20px 1fr 80px 80px; }
        .grid-hacks   { grid-template-columns: 1fr 60px 80px 60px; }
        .grid-bridges { grid-template-columns: 1fr 60px 80px 60px; }
        .grid-chains  { grid-template-columns: 20px 1fr 50px 80px; }
        .grid-hunter  { grid-template-columns: 1fr 40px 80px 60px 60px 60px; }

        /* ETHERSCAN WIDGETS */
        .gas-widget { display: flex; justify-content: space-around; padding: 10px; background: #111; border-bottom: 1px solid #222; }
        .gas-item { text-align: center; }
        .gas-val { font-size: 14px; font-weight: bold; color: #fff; }
        .eth-input-group { padding: 10px; display: flex; gap: 5px; border-bottom: 1px solid #222; }
        .eth-res { padding: 10px; }
        .tx-row { display: flex; justify-content: space-between; border-bottom: 1px solid #222; padding: 4px 0; font-size: 9px; color: #aaa; }

        /* MODAL CHART */
        .modal-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 50; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-content { background: #080808; border: 1px solid #333; width: 90%; height: 80%; display: flex; flex-direction: column; padding: 10px; box-shadow: 0 0 20px #000; }
        .chart-svg { width: 100%; height: 100%; }
        .chart-line { fill: none; stroke: var(--blue); stroke-width: 2; }

        /* FOOTER & TOAST */
        .foot { background: #080808; border-top: 1px solid #333; padding: 4px 10px; color: #666; display: flex; justify-content: space-between; font-size: 10px; align-items: center; height: 30px; }
        #toast-container { position: absolute; bottom: 40px; right: 20px; width: 250px; display: flex; flex-direction: column; gap: 5px; pointer-events: none; z-index: 100; }
        .toast { background: #111; border: 1px solid var(--amber); color: #fff; padding: 10px; pointer-events: auto; box-shadow: 0 5px 15px #000; }

        /* LEFT PANEL STYLES */
        .trade-panel { padding: 10px; display: flex; flex-direction: column; gap: 8px; border-bottom: 1px solid #333; overflow-y: auto; }
        .t-input { background: #000; border: 1px solid #444; color: var(--amber); padding: 5px; width: 100%; text-align: right; font-weight: bold; }
        .btn-trade { width: 100%; padding: 8px; border: none; cursor: pointer; font-weight: 800; color: #000; text-transform: uppercase; }
        .btn-buy { background: var(--green); } .btn-sell { background: var(--red); }
        .position-box { background: #111; border-left: 3px solid #666; padding: 8px; display: none; margin-top: 5px; animation: pop-toast 0.2s; }
        .depth-row { display: flex; justify-content: space-between; position: relative; padding: 1px 8px; font-size: 10px; }
        .depth-bg { position: absolute; top: 0; right: 0; bottom: 0; opacity: 0.2; z-index: 0; transition: width 0.1s; }
        .depth-val { position: relative; z-index: 1; }
    </style>
</head>
<body>

    <div class="ticker-wrap">
        <div class="ticker" id="global-ticker">INITIALIZING GLOBAL MARKET DATA STREAM...</div>
    </div>

    <div class="header">
        <div style="display:flex; gap:15px; align-items:center;">
            <span style="font-weight:900; color:var(--amber); letter-spacing:1px;">BLOOMBERG ENS¬Æ <span style="font-size:9px; color:#666; font-weight:normal;">V17 COMPLETE</span></span>
            <div class="search-box">
                <span style="color:#555">üîç</span>
                <input type="text" id="symbol-input" placeholder="BINANCE PAIR (e.g. BTC)" onkeypress="if(event.key==='Enter') switchPair(this.value)">
            </div>
        </div>
        <div style="display:flex; gap:15px; align-items:center; font-size:10px;">
            <span id="conn-status" style="color:#555">‚óè INIT</span>
            <span id="clock">--:-- UTC</span>
        </div>
    </div>

    <div class="grid">
        <div class="tabs-bar">
            <span class="pair-badge" id="pair-disp">BTCUSDT</span>
            <button class="tab-btn active" onclick="setTab('chart',this)">TRADING</button>
            <button class="tab-btn tab-defi" onclick="setTab('defi',this)">DEFI LLAMA</button>
            <button class="tab-btn tab-dex" onclick="setTab('dex',this)">DEX HUNTER</button>
            <button class="tab-btn tab-eth" onclick="setTab('etherscan',this)">ETHERSCAN</button>
            <div class="tab-spacer"></div>
            <button class="tab-btn" onclick="toggleHistory()">HISTORY</button>
        </div>

        <div class="panel" style="grid-row: span 2;">
            <div class="title"><span style="color:var(--green)">PAPER TRADING</span><span>WALLET</span></div>
            <div class="trade-panel">
                <div style="display:flex; justify-content:space-between; color:#aaa; font-size:10px;"><span>BALANCE</span><span id="wallet-bal" style="color:#fff; font-weight:bold">$10,000.00</span></div>
                <div style="margin-top:5px;"><span style="font-size:9px; color:#666;">SIZE (USD)</span><input type="number" id="trade-size" class="t-input" value="1000"></div>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <button class="btn-trade btn-buy" onclick="openPos('long')">LONG</button>
                    <button class="btn-trade btn-sell" onclick="openPos('short')">SHORT</button>
                </div>
                <div id="pos-box" class="position-box">
                    <div style="display:flex; justify-content:space-between; color:#888;">
                        <span id="pos-side" style="font-weight:bold">LONG</span>
                        <span id="pos-entry">@ 0.00</span>
                    </div>
                    <div id="pos-pnl" style="font-size:16px; font-weight:900; text-align:center; margin:5px 0;">0.00%</div>
                    <button onclick="closePos()" style="width:100%; background:#333; border:none; color:#fff; cursor:pointer;">CLOSE</button>
                </div>
            </div>
            <div class="title"><span>ORDER BOOK</span><span>REAL DATA</span></div>
            <div class="list">
                <div id="asks" style="display:flex; flex-direction:column-reverse;"></div>
                <div id="spread" style="text-align:center; color:#444; border-top:1px solid #222; border-bottom:1px solid #222; font-size:9px;">-</div>
                <div id="bids"></div>
            </div>
        </div>

        <div class="panel" style="grid-row: span 2; position:relative;">
            
            <div id="view-chart" style="width:100%; height:100%;">
                <div id="tv-cont" style="width:100%; height:100%;"></div>
            </div>

            <div id="view-defi" class="hidden" style="width:100%; height:100%; display:flex; flex-direction:column;">
                <div class="sub-nav">
                    <button class="sub-btn active" id="btn-tvl" onclick="loadDefi('tvl')">TVL RANK</button>
                    <button class="sub-btn" id="btn-yields" onclick="loadDefi('yields')">REAL YIELD</button>
                    <button class="sub-btn" id="btn-chains" onclick="loadDefi('chains')">CHAINS</button>
                    <button class="sub-btn" id="btn-fees" onclick="loadDefi('fees')">FEES</button>
                    <button class="sub-btn" id="btn-stables" onclick="loadDefi('stables')">STABLES</button>
                    <button class="sub-btn" id="btn-dex" onclick="loadDefi('dex')">DEX VOL</button>
                    <button class="sub-btn" id="btn-bridges" onclick="loadDefi('bridges')">BRIDGES</button>
                    <button class="sub-btn" id="btn-hacks" style="color:var(--red); border-color:var(--red)" onclick="loadDefi('hacks')">HACKS</button>
                </div>
                
                <div id="yield-filters" style="display:none; padding:5px; background:#111; gap:5px;">
                    <button class="sub-btn" onclick="renderYields('ALL')">ALL</button>
                    <button class="sub-btn" onclick="renderYields('USDT')">USDT</button>
                    <button class="sub-btn" onclick="renderYields('USDC')">USDC</button>
                    <button class="sub-btn" onclick="renderYields('DAI')">DAI</button>
                    <button class="sub-btn" onclick="renderYields('ETH')">ETH</button>
                </div>

                <div id="defi-header-row" class="defi-row defi-head grid-tvl"></div>
                <div id="defi-list" style="overflow-y:auto; flex:1;"></div>
            </div>

            <div id="view-dex" class="hidden" style="width:100%; height:100%; display:flex; flex-direction:column;">
                <div class="dex-search-bar">
                    <input type="text" id="dex-input" class="dex-input" placeholder="SEARCH TOKEN OR ADDRESS..." onkeypress="if(event.key==='Enter') searchDex()">
                    <button onclick="searchDex()" class="sub-btn" style="width:60px;">SCAN</button>
                </div>
                <div class="sub-nav">
                    <span style="color:#666; font-size:9px; padding:4px;">FILTERS:</span>
                    <button class="sub-btn" onclick="filterDex('ALL')">ALL</button>
                    <button class="sub-btn" onclick="filterDex('solana')">SOLANA</button>
                    <button class="sub-btn" onclick="filterDex('ethereum')">ETHEREUM</button>
                    <button class="sub-btn" onclick="filterDex('base')">BASE</button>
                    <button class="sub-btn" onclick="filterDex('bsc')">BSC</button>
                </div>
                <div class="defi-row defi-head grid-hunter">
                    <span>TOKEN / PAIR</span>
                    <span>CHAIN</span>
                    <span style="text-align:right">PRICE</span>
                    <span style="text-align:right">LIQ</span>
                    <span style="text-align:right">1H %</span>
                    <span style="text-align:right">24H %</span>
                </div>
                <div id="dex-list" style="overflow-y:auto; flex:1;">
                    <div style="padding:20px; text-align:center; color:#666;">ENTER SEARCH TO START</div>
                </div>
            </div>

            <div id="view-etherscan" class="hidden" style="width:100%; height:100%; display:flex; flex-direction:column;">
                <div class="title">LIVE GAS TRACKER (GWEI)</div>
                <div class="gas-widget">
                    <div class="gas-item"><span style="color:var(--green)">LOW</span><br><span id="gas-low" class="gas-val">--</span></div>
                    <div class="gas-item"><span style="color:var(--blue)">AVG</span><br><span id="gas-avg" class="gas-val">--</span></div>
                    <div class="gas-item"><span style="color:var(--red)">HIGH</span><br><span id="gas-high" class="gas-val">--</span></div>
                </div>
                
                <div class="title" style="margin-top:10px;">WALLET INSPECTOR (ETH MAINNET)</div>
                <div class="eth-input-group">
                    <input type="text" id="eth-addr" class="dex-input" placeholder="0x... Wallet Address">
                    <button onclick="scanEthWallet()" class="sub-btn">INSPECT</button>
                </div>
                
                <div class="eth-res" id="eth-result">
                    <div style="color:#666; text-align:center; padding:20px;">READY TO SCAN</div>
                </div>
            </div>

            <div id="mini-chart-modal" class="modal-overlay hidden">
                <div class="modal-content">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span id="chart-title" style="font-weight:bold; color:#fff">HISTORY</span>
                        <button onclick="el('mini-chart-modal').classList.add('hidden')" style="background:none; border:none; color:#aaa; cursor:pointer;">X</button>
                    </div>
                    <div id="chart-container" style="flex:1; position:relative; background:#111; border:1px solid #222;"></div>
                </div>
            </div>

        </div>

        <div class="panel">
            <div class="title"><span>TAPE</span><span>TRADES</span></div>
            <div id="tape" class="list"></div>
        </div>
        
        <div class="panel">
            <div class="title"><span>SYSTEM</span><span>STATUS</span></div>
            <div class="list" style="padding:10px; color:#666; font-size:9px;">
                <p>ACTIVE CONNECTIONS:</p>
                <div style="margin-top:5px; color:var(--amber)">‚óè BINANCE STREAM (OK)</div>
                <div style="margin-top:2px; color:var(--blue)">‚óè DEFILLAMA API (OK)</div>
                <div style="margin-top:2px; color:var(--green)">‚óè DEXSCREENER API (OK)</div>
                <div style="margin-top:2px; color:#627eea">‚óè ETHERSCAN API (KEY LOADED)</div>
            </div>
        </div>
    </div>

    <div class="panel" style="height:120px; border-top:1px solid #333; display:none;" id="history-panel">
        <div class="title"><span>HISTORY</span><button onclick="toggleHistory()" style="background:none;border:none;color:#fff;">X</button></div>
        <div class="list" id="history-list"></div>
    </div>

    <div class="foot">
        <div style="display:flex; gap:20px;">
            <span>PRICE: <span id="ft-price" style="color:#fff">--</span></span>
            <span>24H: <span id="ft-chg">--</span></span>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="toggleSound()" style="background:none; border:1px solid #333; color:#666; cursor:pointer;">SOUND: OFF</button>
            <button onclick="resetApp()" style="background:none; border:1px solid #333; color:#666; cursor:pointer;">RESET</button>
        </div>
    </div>
    <div id="toast-container"></div>

    <script>
        // --- CORE & STATE ---
        let state = { pair: 'btcusdt', wallet: 10000, pos: null, history: [], sound: false };
        let yieldCache = [];
        let dexCache = [];
        const ETHERSCAN_KEY = 'RQI9E2XA359F65EXRJXHY3W9MP4ZFQ2CYV';
        const el = id => document.getElementById(id);
        let ws = null, audioCtx = null;

        // --- 1. TRADING ENGINE ---
        function openPos(side) {
            if(state.pos) return toast("ERR", "Position already open");
            const price = parseFloat(el('ft-price').innerText);
            if(!price) return;
            state.pos = { side, entry: price, size: parseFloat(el('trade-size').value) };
            el('pos-box').style.display = 'block';
            el('pos-side').innerText = side.toUpperCase();
            el('pos-entry').innerText = "@ " + price.toFixed(2);
            updateWallet();
            toast("EXEC", `${side.toUpperCase()} FILLED`);
            playSound('success');
        }
        function closePos() {
            if(!state.pos) return;
            const price = parseFloat(el('ft-price').innerText);
            const pnl = (price - state.pos.entry) / state.pos.entry * (state.pos.side==='long'?1:-1) * 20 * state.pos.size; 
            state.wallet += pnl;
            state.history.unshift({t:new Date().toLocaleTimeString(), p:pnl});
            state.pos = null;
            el('pos-box').style.display = 'none';
            updateWallet();
            toast("EXEC", `CLOSED PNL: $${pnl.toFixed(2)}`);
            playSound('ping');
        }
        function updateWallet() { el('wallet-bal').innerText = "$" + state.wallet.toLocaleString(undefined, {minimumFractionDigits:2}); }

        // --- 2. DEFI LLAMA LOGIC ---
        const fmt = (n) => {
            if(n === undefined || n === null) return '-';
            if(Math.abs(n) > 1e9) return (n/1e9).toFixed(2) + 'B';
            if(Math.abs(n) > 1e6) return (n/1e6).toFixed(2) + 'M';
            if(Math.abs(n) > 1e3) return (n/1e3).toFixed(2) + 'K';
            return n.toFixed(2);
        };

        async function loadDefi(mode) {
            const list = el('defi-list');
            const head = el('defi-header-row');
            const filters = el('yield-filters');
            
            // Toggle Sub-nav Active State
            document.querySelectorAll('#view-defi .sub-btn').forEach(b => b.classList.remove('active'));
            const btn = el('btn-'+mode);
            if(btn) btn.classList.add('active');
            
            // Show filters only for Yields
            filters.style.display = (mode === 'yields') ? 'flex' : 'none';
            list.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">FETCHING LIVE DATA...</div>';
            
            try {
                let html = '';
                switch(mode) {
                    case 'tvl':
                        head.className = 'defi-row defi-head grid-tvl';
                        head.innerHTML = `<span>#</span><span>PROTOCOL</span><span style="text-align:right;">TVL</span><span style="text-align:right;">24H</span>`;
                        const resTvl = await fetch('https://api.llama.fi/protocols');
                        let dataTvl = await resTvl.json();
                        dataTvl.sort((a,b) => (b.tvl||0) - (a.tvl||0));
                        dataTvl.slice(0, 50).forEach((p, i) => {
                            const chg = p.change_1d || 0;
                            html += `<div class="defi-row grid-tvl" onclick="openChart('${p.slug}', '${p.name}')"><span style="color:#444">${i+1}</span><span style="font-weight:bold; color:#fff">${p.name} <span style="font-size:9px; color:#666">(${p.symbol})</span></span><span style="text-align:right; color:var(--blue); font-family:monospace;">$${fmt(p.tvl)}</span><span style="text-align:right; color:${chg>=0?'var(--green)':'var(--red)'}">${chg.toFixed(2)}%</span></div>`;
                        });
                        list.innerHTML = html;
                        toast("INFO", "Click rows for History");
                        break;

                    case 'yields':
                        head.className = 'defi-row defi-head grid-yield';
                        head.innerHTML = `<span>POOL</span><span style="text-align:right">CHAIN</span><span style="text-align:right">TVL</span><span style="text-align:right">BASE</span><span style="text-align:right">RWD</span>`;
                        const resYield = await fetch('https://yields.llama.fi/pools');
                        const wYield = await resYield.json();
                        // Filter & Cache
                        yieldCache = wYield.data.filter(p => p.tvlUsd > 1000000 && p.apy > 0).sort((a,b) => b.apy - a.apy);
                        renderYields('ALL');
                        break;

                    case 'chains':
                        head.className = 'defi-row defi-head grid-chains';
                        head.innerHTML = `<span>#</span><span>CHAIN</span><span>TOKEN</span><span style="text-align:right;">TVL</span>`;
                        const resChain = await fetch('https://api.llama.fi/v2/chains');
                        const dataChain = await resChain.json();
                        dataChain.sort((a,b) => (b.tvl||0) - (a.tvl||0));
                        dataChain.slice(0, 30).forEach((p, i) => {
                            html += `<div class="defi-row grid-chains"><span style="color:#444">${i+1}</span><span style="font-weight:bold; color:#fff">${p.name}</span><span style="color:#aaa; font-size:9px;">${p.tokenSymbol||'-'}</span><span style="text-align:right; color:var(--blue); font-family:monospace;">$${fmt(p.tvl)}</span></div>`;
                        });
                        list.innerHTML = html;
                        break;

                    case 'fees':
                        head.className = 'defi-row defi-head grid-fees';
                        head.innerHTML = `<span>#</span><span>PROTOCOL</span><span style="text-align:right;">FEES 24H</span><span style="text-align:right;">FEES 7D</span>`;
                        const resFees = await fetch('https://api.llama.fi/overview/fees?excludeTotalDataChart=true&excludeTotalDataChartBreakdown=true&dataType=dailyFees');
                        const dataFees = await resFees.json();
                        dataFees.protocols.sort((a,b) => (b.total24h||0) - (a.total24h||0));
                        dataFees.protocols.slice(0, 50).forEach((p, i) => {
                            html += `<div class="defi-row grid-fees"><span style="color:#444">${i+1}</span><span style="font-weight:bold; color:#fff">${p.name}</span><span style="text-align:right; color:var(--green); font-family:monospace;">$${fmt(p.total24h)}</span><span style="text-align:right; color:#888; font-family:monospace;">$${fmt(p.total7d)}</span></div>`;
                        });
                        list.innerHTML = html;
                        break;

                    case 'stables':
                        head.className = 'defi-row defi-head grid-stables';
                        head.innerHTML = `<span>NAME</span><span style="text-align:right">PRICE</span><span style="text-align:right">M.CAP</span><span style="text-align:right">PEG</span>`;
                        const resStb = await fetch('https://stablecoins.llama.fi/stablecoins');
                        const wStb = await resStb.json();
                        wStb.peggedAssets.sort((a,b) => (b.circulating?.peggedUSD || 0) - (a.circulating?.peggedUSD || 0));
                        wStb.peggedAssets.slice(0,50).forEach(p => {
                            const price = p.price || 0;
                            const isDepeg = price < 0.99 || price > 1.01;
                            html += `<div class="defi-row grid-stables"><span style="font-weight:bold; color:#fff">${p.name} <span style="font-size:9px; color:#666">(${p.symbol})</span></span><span style="text-align:right; color:${isDepeg?'var(--red)':'var(--liq)'}; font-weight:bold;">$${price.toFixed(4)}</span><span style="text-align:right; font-family:monospace; color:#888">$${fmt(p.circulating?.peggedUSD)}</span><span style="text-align:right; font-size:9px; color:#555">${p.pegMechanism}</span></div>`;
                        });
                        list.innerHTML = html;
                        break;

                    case 'dex':
                        head.className = 'defi-row defi-head grid-dex';
                        head.innerHTML = `<span>#</span><span>DEX</span><span style="text-align:right">VOL 24H</span><span style="text-align:right">VOL 7D</span>`;
                        const resDex = await fetch('https://api.llama.fi/overview/dexs?excludeTotalDataChart=true&excludeTotalDataChartBreakdown=true&dataType=dailyVolume');
                        const wDex = await resDex.json();
                        wDex.protocols.sort((a,b) => (b.total24h||0) - (a.total24h||0));
                        wDex.protocols.slice(0,50).forEach((p,i) => {
                            html += `<div class="defi-row grid-dex"><span style="color:#444">${i+1}</span><span style="font-weight:bold; color:#fff">${p.name}</span><span style="text-align:right; color:var(--purple); font-family:monospace;">$${fmt(p.total24h)}</span><span style="text-align:right; color:#666; font-family:monospace;">$${fmt(p.total7d)}</span></div>`;
                        });
                        list.innerHTML = html;
                        break;

                    case 'bridges':
                        head.className = 'defi-row defi-head grid-bridges';
                        head.innerHTML = `<span>BRIDGE</span><span style="text-align:right">CHAINS</span><span style="text-align:right">VOL 24H</span><span style="text-align:right">VOL 7D</span>`;
                        const resBri = await fetch('https://bridges.llama.fi/bridges?includeChains=true');
                        const wBri = await resBri.json();
                        let dBri = wBri.bridges.sort((a,b) => (b.volume24h||0) - (a.volume24h||0));
                        dBri.forEach(p => {
                            html += `<div class="defi-row grid-bridges"><span style="font-weight:bold; color:#fff">${p.displayName}</span><span style="text-align:right; font-size:9px; color:#aaa">${p.chains.length}</span><span style="text-align:right; color:var(--liq); font-family:monospace;">$${fmt(p.volume24h)}</span><span style="text-align:right; color:#666; font-family:monospace;">$${fmt(p.volume7d)}</span></div>`;
                        });
                        list.innerHTML = html;
                        break;

                    case 'hacks':
                        head.className = 'defi-row defi-head grid-hacks';
                        head.innerHTML = `<span>PROTOCOL</span><span style="text-align:right">CHAIN</span><span style="text-align:right">LOST</span><span style="text-align:right">DATE</span>`;
                        const resHack = await fetch('https://api.llama.fi/hacks');
                        const wHack = await resHack.json();
                        wHack.sort((a,b) => b.amount - a.amount);
                        wHack.slice(0, 100).forEach(p => {
                            html += `<div class="defi-row grid-hacks"><span style="font-weight:bold; color:#fff; overflow:hidden; text-overflow:ellipsis;">${p.name} <span style="font-size:9px; color:#666">(${p.classification})</span></span><span style="text-align:right; font-size:9px; color:#aaa">${p.chain}</span><span style="text-align:right; color:var(--red); font-family:monospace;">$${fmt(p.amount)}</span><span style="text-align:right; font-size:9px; color:#666">${new Date(p.date*1000).toLocaleDateString()}</span></div>`;
                        });
                        list.innerHTML = html;
                        break;
                }
                toast("API", "Data Loaded");
            } catch (e) {
                console.error(e);
                list.innerHTML = `<div style="padding:20px; text-align:center; color:var(--red);">ERROR FETCHING DATA</div>`;
                toast("ERR", "Fetch Failed");
            }
        }

        // --- RENDER FILTERED YIELDS ---
        function renderYields(filter) {
            const list = el('defi-list');
            let data = yieldCache;
            if (filter !== 'ALL') data = data.filter(p => p.symbol.toUpperCase().includes(filter));
            let html = '';
            data.slice(0, 100).forEach(p => {
                const base = p.apyBase !== null ? p.apyBase : p.apy;
                const reward = p.apyReward !== null ? p.apyReward : 0;
                html += `<div class="defi-row grid-yield"><span style="font-weight:bold; color:#fff; overflow:hidden; text-overflow:ellipsis;">${p.project.toUpperCase()} <span style="color:#666; font-weight:normal">${p.symbol}</span></span><span style="text-align:right; font-size:9px; color:#aaa">${p.chain}</span><span style="text-align:right; font-family:monospace; color:#666">$${fmt(p.tvlUsd)}</span><span style="text-align:right; color:var(--amber); font-weight:bold;">${base.toFixed(2)}%</span><span style="text-align:right; color:var(--purple); font-weight:bold;">${reward.toFixed(2)}%</span></div>`;
            });
            list.innerHTML = html || '<div style="padding:20px; text-align:center;">NO MATCHES</div>';
        }

        // --- 3. DEX HUNTER LOGIC ---
        async function searchDex() {
            const q = el('dex-input').value;
            if(!q) return;
            const list = el('dex-list');
            list.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">SCANNING DEXES...</div>';
            try {
                const res = await fetch(`https://api.dexscreener.com/latest/dex/search?q=${q}`);
                const data = await res.json();
                if(!data.pairs || data.pairs.length === 0) {
                    list.innerHTML = '<div style="padding:20px; text-align:center; color:#555;">NO PAIRS FOUND</div>';
                    return;
                }
                dexCache = data.pairs.filter(p => p.liquidity && p.liquidity.usd > 1000).sort((a,b) => b.liquidity.usd - a.liquidity.usd);
                filterDex('ALL');
            } catch(e) {
                list.innerHTML = '<div style="padding:20px; text-align:center; color:var(--red);">DEX API ERROR</div>';
            }
        }

        function filterDex(chain) {
            const list = el('dex-list');
            let data = dexCache;
            if(chain !== 'ALL') data = data.filter(p => p.chainId === chain);
            
            let html = '';
            data.forEach(p => {
                const c1h = p.priceChange.h1 || 0;
                const c24h = p.priceChange.h24 || 0;
                html += `
                <div class="defi-row grid-hunter" onclick="window.open('${p.url}', '_blank')">
                    <span style="font-weight:bold; color:#fff; overflow:hidden; text-overflow:ellipsis;">${p.baseToken.symbol}/${p.quoteToken.symbol} <span style="font-size:9px; color:#666">${p.dexId}</span></span>
                    <span style="color:#aaa; text-transform:uppercase;">${p.chainId}</span>
                    <span style="text-align:right; font-family:monospace; color:var(--liq)">$${parseFloat(p.priceUsd).toFixed(6)}</span>
                    <span style="text-align:right; font-family:monospace; color:#666">$${fmt(p.liquidity.usd)}</span>
                    <span style="text-align:right; color:${c1h>=0?'var(--green)':'var(--red)'}">${c1h.toFixed(2)}%</span>
                    <span style="text-align:right; color:${c24h>=0?'var(--green)':'var(--red)'}">${c24h.toFixed(2)}%</span>
                </div>`;
            });
            list.innerHTML = html || '<div style="padding:20px; text-align:center; color:#555;">NO MATCHES ON THIS CHAIN</div>';
        }

        // --- 4. ETHERSCAN TOOL LOGIC ---
        async function initEtherscan() {
            try {
                const res = await fetch(`https://api.etherscan.io/api?module=gastracker&action=gasoracle&apikey=${ETHERSCAN_KEY}`);
                const data = await res.json();
                if(data.status === "1") {
                    el('gas-low').innerText = data.result.SafeGasPrice;
                    el('gas-avg').innerText = data.result.ProposeGasPrice;
                    el('gas-high').innerText = data.result.FastGasPrice;
                }
            } catch(e) { console.log(e); }
        }

        async function scanEthWallet() {
            const addr = el('eth-addr').value;
            const resBox = el('eth-result');
            if(!addr) return;
            resBox.innerHTML = '<div style="color:#666; text-align:center;">SCANNING CHAIN...</div>';
            try {
                const balRes = await fetch(`https://api.etherscan.io/api?module=account&action=balance&address=${addr}&tag=latest&apikey=${ETHERSCAN_KEY}`);
                const balData = await balRes.json();
                const balEth = (balData.result / 1e18).toFixed(4);

                const txRes = await fetch(`https://api.etherscan.io/api?module=account&action=txlist&address=${addr}&startblock=0&endblock=99999999&page=1&offset=5&sort=desc&apikey=${ETHERSCAN_KEY}`);
                const txData = await txRes.json();
                let txHtml = '';
                if(txData.result && Array.isArray(txData.result)) {
                    txData.result.forEach(tx => {
                        const val = (tx.value / 1e18).toFixed(4);
                        const isIn = tx.to.toLowerCase() === addr.toLowerCase();
                        txHtml += `<div class="tx-row"><span style="color:#fff">${tx.hash.substring(0,8)}...</span><span style="color:${isIn?'var(--green)':'var(--red)'}">${isIn?'IN':'OUT'}</span><span>${val} ETH</span></div>`;
                    });
                }
                resBox.innerHTML = `<div style="font-size:16px; color:#fff; font-weight:bold; margin-bottom:10px;">BALANCE: <span style="color:var(--blue)">${balEth} ETH</span></div><div style="border-top:1px solid #333; padding-top:5px;"><div style="font-size:9px; color:#666; margin-bottom:5px;">LAST 5 TXs</div>${txHtml}</div>`;
            } catch(e) { resBox.innerHTML = '<div style="color:var(--red); text-align:center;">INVALID ADDRESS</div>'; }
        }

        // --- 5. TABS & UI ROUTING ---
        function setTab(t, btn) {
            ['view-chart', 'view-defi', 'view-dex', 'view-etherscan'].forEach(id => el(id).classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            if(t === 'chart') el('view-chart').classList.remove('hidden');
            if(t === 'defi') { el('view-defi').classList.remove('hidden'); if(el('defi-list').innerHTML==='') loadDefi('tvl'); }
            if(t === 'dex') el('view-dex').classList.remove('hidden');
            if(t === 'etherscan') { el('view-etherscan').classList.remove('hidden'); initEtherscan(); }
        }

        // --- CHART SVG ---
        async function openChart(slug, name) {
            const modal = el('mini-chart-modal');
            const cont = el('chart-container');
            el('chart-title').innerText = name.toUpperCase() + " : TVL HISTORY";
            modal.classList.remove('hidden');
            cont.innerHTML = '<div style="color:#666; text-align:center; padding-top:50px;">LOADING...</div>';
            try {
                const res = await fetch(`https://api.llama.fi/protocol/${slug}`);
                const data = await res.json();
                let points = data.tvl || [];
                if(points.length > 300) points = points.filter((_, i) => i % Math.ceil(points.length/300) === 0);
                
                let min = Infinity, max = -Infinity;
                points.forEach(p => { if(p.totalLiquidityUSD < min) min = p.totalLiquidityUSD; if(p.totalLiquidityUSD > max) max = p.totalLiquidityUSD; });
                
                const w = cont.clientWidth || 600; const h = cont.clientHeight || 300;
                let d = `M 0 ${h} `;
                points.forEach((p, i) => {
                    const x = (i/(points.length-1))*w;
                    const y = h - ((p.totalLiquidityUSD - min)/(max - min))*(h-20) - 10;
                    d += `L ${x} ${y} `;
                });
                cont.innerHTML = `<svg class="chart-svg" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none"><path d="${d}" class="chart-line" /></svg>`;
            } catch(e) { cont.innerHTML = 'ERR'; }
        }

        // --- SYSTEM ---
        function switchPair(p) {
            if(!p.toUpperCase().endsWith('USDT')) p+='USDT';
            state.pair = p.toLowerCase();
            el('pair-disp').innerText = p.toUpperCase();
            startStream(); initTV();
            toast("SYSTEM", `SWITCHED TO ${p.toUpperCase()}`);
        }
        function startStream() {
            if(ws) ws.close();
            el('conn-status').innerText = "‚óè SYNC";
            ws = new WebSocket(`wss://stream.binance.com:9443/stream?streams=${state.pair}@trade/${state.pair}@depth10@100ms/${state.pair}@ticker`);
            ws.onopen = () => el('conn-status').innerText = "‚óè LIVE";
            ws.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                const type = msg.stream.split('@')[1];
                if(type === 'trade') {
                    const d = msg.data;
                    const row = `<div class="row"><span style="color:#555">${new Date().toLocaleTimeString()}</span><span style="color:${d.m?'var(--red)':'var(--green)'}">${parseFloat(d.p).toFixed(2)}</span><span>${parseFloat(d.q).toFixed(4)}</span></div>`;
                    const tape = el('tape'); if(tape) { tape.insertAdjacentHTML('afterbegin', row); if(tape.children.length>30) tape.lastChild.remove(); }
                }
                if(type === 'ticker') { el('ft-price').innerText = parseFloat(msg.data.c).toFixed(2); el('ft-chg').innerText = parseFloat(msg.data.P).toFixed(2) + "%"; }
                if(type.startsWith('depth')) {
                    el('asks').innerHTML = msg.data.asks.slice(0,10).reverse().map(a=>`<div class="depth-row"><div class="depth-bg" style="width:${Math.random()*100}%; background:var(--red)"></div><span class="depth-val" style="color:var(--red)">${parseFloat(a[0]).toFixed(2)}</span><span class="depth-val">${parseFloat(a[1]).toFixed(3)}</span></div>`).join('');
                    el('bids').innerHTML = msg.data.bids.slice(0,10).map(a=>`<div class="depth-row"><div class="depth-bg" style="width:${Math.random()*100}%; background:var(--green)"></div><span class="depth-val" style="color:var(--green)">${parseFloat(a[0]).toFixed(2)}</span><span class="depth-val">${parseFloat(a[1]).toFixed(3)}</span></div>`).join('');
                }
            };
        }
        function initTV() { el('tv-cont').innerHTML = ''; new TradingView.widget({ "autosize": true, "symbol": "BINANCE:"+state.pair.toUpperCase(), "interval": "1", "theme": "dark", "style": "1", "container_id": "tv-cont", "toolbar_bg": "#000", "enable_publishing": false, "hide_side_toolbar": false, "overrides": { "paneProperties.background": "#000000" } }); }
        function toast(t,m) { const d = document.createElement('div'); d.className='toast pop-toast'; d.innerHTML=`<b>${t}</b><br>${m}`; el('toast-container').appendChild(d); setTimeout(()=>d.remove(),3000); }
        function toggleHistory() { const p = el('history-panel'); p.style.display=p.style.display==='none'?'flex':'none'; el('history-list').innerHTML = state.history.map(h=>`<div class="row"><span>${h.t}</span><span>PNL: ${h.p.toFixed(2)}$</span></div>`).join(''); }
        function resetApp() { if(confirm("Reset?")) location.reload(); }
        function toggleSound() { state.sound = !state.sound; if(state.sound) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); toast("AUDIO", "Sound FX Enabled"); } }
        function playSound(type) { if(!state.sound || !audioCtx) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type = type === 'ping' ? 'sine' : 'triangle'; o.frequency.setValueAtTime(type==='ping'?800:400, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(type==='ping'?400:800, audioCtx.currentTime + 0.1); g.gain.setValueAtTime(0.1, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1); o.start(); o.stop(audioCtx.currentTime + 0.1); }

        setInterval(() => el('clock').innerText = new Date().toISOString().split('T')[1].split('.')[0] + ' UTC', 1000);
        startStream(); initTV();
    </script>
</body>
</html>
