<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLOOMBERG ENS® - DEFI TERMINAL v12</title>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <style>
        :root { --bg: #000; --amber: #ffaa00; --dim: #666; --green: #0f0; --red: #f00; --blue: #00f0ff; --border: #333; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Courier New', monospace; user-select: none; }
        body { background: var(--bg); color: var(--amber); height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-size: 10px; }
        
        ::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-thumb { background: #333; }

        /* HEADER */
        .ticker-wrap { background: #111; border-bottom: 1px solid var(--amber); white-space: nowrap; overflow: hidden; padding: 2px 0; }
        .ticker { display: inline-block; animation: ticker 45s linear infinite; }
        @keyframes ticker { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .tick-item { margin-right: 20px; font-weight: bold; cursor: pointer; }

        .header { background: var(--amber); color: #000; padding: 4px 10px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .gas-badge { background: #000; color: var(--amber); padding: 1px 6px; border: 1px solid #000; font-size: 9px; display:flex; gap:5px; }

        /* GRID LAYOUT (RETOUR AU CLASSIQUE STABLE) */
        .grid { display: grid; grid-template-columns: 260px 1fr 280px; grid-template-rows: 30px 1fr 60px; gap: 1px; background: var(--border); flex-grow: 1; }
        .panel { background: var(--bg); display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .title { background: #111; padding: 3px 5px; border-bottom: 1px solid var(--border); color: var(--dim); font-weight: bold; display: flex; justify-content: space-between; font-size: 9px; }

        /* TABS */
        .tabs-bar { grid-column: span 3; background: #000; display: flex; align-items: center; border-bottom: 1px solid var(--border); padding: 0 10px; }
        .tab-btn { background: #111; border: 1px solid #333; color: #666; padding: 3px 10px; cursor: pointer; margin-right: 2px; font-size: 9px; }
        .tab-btn.active { background: var(--amber); color: #000; font-weight: bold; }

        /* PANELS CONTENT */
        .list { overflow-y: auto; flex-grow: 1; }
        .row { display: flex; justify-content: space-between; padding: 1px 6px; border-bottom: 1px solid #080808; font-size: 10px; }
        .whale { color: var(--amber); font-weight: bold; background: rgba(255, 170, 0, 0.15); }
        
        /* NEWS & BLOCKCHAIN ITEMS */
        .news-item { padding: 8px 5px; border-bottom: 1px solid #222; cursor: pointer; line-height: 1.2; }
        .news-item:hover { background: #111; color: #fff; }
        .wallet-item { padding: 8px 5px; border-bottom: 1px solid #222; font-size:9px; word-break: break-all; cursor:pointer; }
        .wallet-item:hover { background: #111; }

        /* TRADING INPUTS */
        .trade-panel { padding: 10px; border-bottom: 1px solid #333; display: flex; flex-direction: column; gap: 6px; }
        .t-input { background: #111; border: 1px solid #333; color: #fff; width: 100%; text-align: right; padding: 4px; }
        .btn-row { display: flex; gap: 5px; }
        .btn-trade { flex: 1; padding: 5px; border: none; cursor: pointer; font-weight: bold; color: #000; }
        .btn-buy { background: var(--green); } .btn-sell { background: var(--red); }
        .pos-box { background: #111; border: 1px solid #333; padding: 5px; margin-top: 5px; display: none; }

        /* CHART CONTAINER */
        #chart-area { width: 100%; height: 100%; position: relative; }
        iframe { border: none; width: 100%; height: 100%; }

        /* STATS */
        .stats-grid { grid-column: span 3; display: grid; grid-template-columns: repeat(5, 1fr); gap: 1px; background: var(--border); }
        .stat-box { background: var(--bg); display: flex; flex-direction: column; justify-content: center; padding: 0 10px; }
        .s-lbl { color: #666; font-size: 8px; } .s-val { font-size: 12px; font-weight: bold; }

        /* FOOTER */
        .foot { background: #111; border-top: 1px solid #333; padding: 2px 10px; color: var(--dim); display: flex; justify-content: space-between; font-size: 9px; align-items: center; flex-shrink: 0; }
        .hidden { display: none !important; }
        .g { color: var(--green); } .r { color: var(--red); }
    </style>
</head>
<body>

    <div class="ticker-wrap"><div class="ticker" id="global-ticker">INITIALIZING MARKET DATA...</div></div>

    <div class="header">
        <span>BLOOMBERG ENS v12 [DEFI EDITION]</span>
        <div style="display:flex; gap:10px; align-items:center;">
            <div class="gas-badge">⛽ GAS: <span id="gas-val" style="color:#fff">--</span> <span style="color:#666">Gwei</span></div>
            <span id="clock">--:--:--</span>
        </div>
    </div>

    <div class="grid">
        <div class="tabs-bar">
            <span style="color:var(--amber); font-weight:bold; margin-right:15px;" id="pair-disp">BTCUSDT</span>
            <button class="tab-btn active" onclick="setTab('trade')">TRADING</button>
            <button class="tab-btn" onclick="setTab('chain')">BLOCKCHAIN</button>
            <button class="tab-btn" onclick="setTab('news')">NEWS WIRE</button>
            <div style="flex-grow:1"></div>
            <div id="tf-buttons">
                <button class="tab-btn" onclick="setTf('1')">1m</button>
                <button class="tab-btn" onclick="setTf('15')">15m</button>
                <button class="tab-btn" onclick="setTf('60')">1H</button>
            </div>
        </div>

        <div class="panel" style="grid-row: span 2;">
            
            <div id="tab-trade">
                <div class="title"><span style="color:var(--green)">PAPER TRADING</span><span>WALLET</span></div>
                <div class="trade-panel">
                    <div style="display:flex; justify-content:space-between; color:#888; font-size:9px;">
                        <span>EQUITY</span><span id="wallet-bal" style="color:#fff; font-weight:bold">--</span>
                    </div>
                    <input type="number" id="trade-size" class="t-input" placeholder="SIZE (USD)" value="1000">
                    <div class="btn-row">
                        <button class="btn-trade btn-buy" onclick="trade('long')">BUY</button>
                        <button class="btn-trade btn-sell" onclick="trade('short')">SELL</button>
                    </div>
                    <div id="pos-box" class="pos-box">
                        <div style="display:flex; justify-content:space-between;">
                            <span id="pos-side">LONG</span><span id="pos-pnl">--</span>
                        </div>
                        <button onclick="closePos()" style="width:100%; background:#333; color:#fff; border:none; margin-top:5px; cursor:pointer;">CLOSE</button>
                    </div>
                </div>
                <div class="title"><span>ORDER BOOK</span><span>DEPTH</span></div>
                <div class="list">
                    <div id="asks" style="display:flex; flex-direction:column-reverse;"></div>
                    <div id="spread" style="text-align:center; color:#444; border-y:1px solid #222;">-</div>
                    <div id="bids"></div>
                </div>
            </div>

            <div id="tab-chain" class="hidden list">
                <div class="title"><span style="color:var(--blue)">GAS TRACKER</span><span>ETH MAINNET</span></div>
                <div style="padding:10px; border-bottom:1px solid #222;">
                    <div style="font-size:14px; font-weight:bold; color:#fff;" id="gas-detail">-- Gwei</div>
                    <div style="color:#666; font-size:9px;">Update: Real-time estimate</div>
                </div>

                <div class="title"><span>WALLET WATCHER</span><span>TRACK</span></div>
                <div style="padding:5px; border-bottom:1px solid #222;">
                    <input type="text" id="wallet-input" class="t-input" placeholder="0x Address..." style="text-align:left;">
                    <button onclick="addWallet()" style="width:100%; margin-top:5px; background:#222; color:#ccc; border:1px solid #444; cursor:pointer;">ADD TO WATCHLIST</button>
                </div>
                <div id="wallet-list">
                    </div>
            </div>

            <div id="tab-news" class="hidden list">
                <div style="padding:10px; text-align:center; color:#666">LOADING WIRE...</div>
            </div>
        </div>

        <div class="panel" style="grid-row: span 2;">
            <div id="chart-area"></div> </div>

        <div class="panel" style="grid-row: span 2;">
            <div class="title"><span>TAPE & WHALES</span><span>LIVE</span></div>
            <div id="tape" class="list"></div>
        </div>

        <div class="stats-grid">
            <div class="stat-box"><span class="s-lbl">24H HIGH</span><span class="s-val" id="high">--</span></div>
            <div class="stat-box"><span class="s-lbl">24H LOW</span><span class="s-val" id="low">--</span></div>
            <div class="stat-box"><span class="s-lbl">VOLUME</span><span class="s-val" id="vol">--</span></div>
            <div class="stat-box"><span class="s-lbl">CHANGE</span><span class="s-val" id="chg">--</span></div>
            <div class="stat-box"><span class="s-lbl">STATUS</span><span class="s-val" style="color:var(--green)">ONLINE</span></div>
        </div>
    </div>

    <div class="foot">
        <div>SYSTEM: <span id="sys-mode">BINANCE MODE</span> | PING: <span id="ping">--ms</span></div>
        <div style="display:flex; gap:5px;">
            <input id="cmd" type="text" style="background:#000; border:1px solid #333; color:var(--amber); width:200px; text-align:center; font-weight:bold;" placeholder="CMD (Token or 0x...)">
        </div>
    </div>

    <script>
        // --- CONFIG ---
        let currentPair = 'btcusdt';
        let wallet = 10000;
        let position = null;
        let ws = null; 
        let isDefiMode = false; // Mode toggle
        let savedWallets = JSON.parse(localStorage.getItem('bloomberg_wallets') || '[]');

        const el = id => document.getElementById(id);

        // --- 1. PERSISTENCE ---
        function loadData() {
            const d = JSON.parse(localStorage.getItem('bloomberg_v12') || '{}');
            if(d.wallet) wallet = d.wallet;
            position = d.position;
            updateWalletUI();
            renderWallets();
        }
        function saveData() { localStorage.setItem('bloomberg_v12', JSON.stringify({ wallet, position })); }

        // --- 2. LOGIC CONTROLLER (BINANCE vs DEFI) ---
        function handleCommand(input) {
            input = input.trim();
            
            // DETECTION MODE DEFI (Adresse Contrat)
            if (input.startsWith('0x') && input.length > 30) {
                enableDefiMode(input);
            } 
            // DETECTION MODE CLASSIQUE (Symbole)
            else {
                let pair = input.toLowerCase();
                if(!pair.endsWith('usdt')) pair += 'usdt';
                enableBinanceMode(pair);
            }
        }

        function enableDefiMode(address) {
            isDefiMode = true;
            el('sys-mode').innerText = "DEFI MODE (DEXSCREENER)";
            el('sys-mode').style.color = "var(--blue)";
            el('pair-disp').innerText = "CONTRACT: " + address.substring(0,6) + "...";
            
            // 1. Load DexScreener Iframe
            el('chart-area').innerHTML = `<iframe src="https://dexscreener.com/ethereum/${address}?embed=1&theme=dark&trades=0&info=0"></iframe>`;
            
            // 2. Stop Binance Streams (Pas de data WS pour les shitcoins on-chain ici sans API complexe)
            if(ws) ws.close();
            el('tape').innerHTML = '<div style="padding:10px;color:#666;text-align:center">TAPE DISABLED IN DEFI MODE</div>';
            el('asks').innerHTML = '';
            el('bids').innerHTML = '';
        }

        function enableBinanceMode(pair) {
            isDefiMode = false;
            currentPair = pair;
            el('sys-mode').innerText = "BINANCE MODE";
            el('sys-mode').style.color = "var(--amber)";
            el('pair-disp').innerText = pair.toUpperCase();
            
            // 1. Load TradingView
            el('chart-area').innerHTML = '<div id="tv-div" style="width:100%;height:100%"></div>';
            new TradingView.widget({
                "autosize": true, "symbol": "BINANCE:"+pair.toUpperCase(), "interval": "1",
                "timezone": "Etc/UTC", "theme": "dark", "style": "1", "locale": "fr", "toolbar_bg": "#000",
                "enable_publishing": false, "container_id": "tv-div", "hide_side_toolbar": false,
                "overrides": { "paneProperties.background": "#000000" }
            });

            // 2. Restart Binance Streams
            startBinanceStream(pair);
        }

        // --- 3. BINANCE STREAMS ---
        function startBinanceStream(pair) {
            if(ws) ws.close();
            const streams = [`${pair}@depth10`, `${pair}@trade`, `${pair}@ticker`].join('/');
            ws = new WebSocket(`wss://stream.binance.com:9443/stream?streams=${streams}`);
            
            ws.onopen = () => el('ping').style.color = '#0f0';
            ws.onmessage = e => {
                const msg = JSON.parse(e.data);
                if(msg.stream.includes('trade')) handleTrade(msg.data);
                if(msg.stream.includes('depth')) handleDepth(msg.data);
                if(msg.stream.includes('ticker')) handleTicker(msg.data);
            };
        }

        // --- 4. DATA HANDLERS ---
        function handleTrade(d) {
            const p = parseFloat(d.p);
            const q = parseFloat(d.q);
            const val = p * q;
            
            // Tape
            const row = document.createElement('div');
            row.className = 'row';
            if(val > 50000) row.classList.add('whale');
            row.innerHTML = `<span style="color:#666">${new Date(d.T).toLocaleTimeString().split(' ')[0]}</span><span class="${d.m?'r':'g'}">${p.toFixed(2)}</span><span>${q.toFixed(4)}</span>`;
            el('tape').prepend(row);
            if(el('tape').children.length > 30) el('tape').lastChild.remove();

            // PnL
            if(position && !isDefiMode) {
                const diff = position.side === 'long' ? (p - position.entry) : (position.entry - p);
                const pnl = diff * position.amt;
                el('pos-pnl').innerText = pnl.toFixed(2);
                el('pos-pnl').style.color = pnl>=0?'#0f0':'#f00';
            }
        }

        function handleDepth(d) {
            renderList(d.asks, el('asks'), 'r', true);
            renderList(d.bids, el('bids'), 'g', false);
            el('spread').innerText = (parseFloat(d.asks[0][0]) - parseFloat(d.bids[0][0])).toFixed(2);
        }
        function renderList(l, c, col, rev) {
            c.innerHTML = '';
            (rev ? l.slice(0,8).reverse() : l.slice(0,8)).forEach(i => {
                c.innerHTML += `<div class="row"><span class="${col}">${parseFloat(i[0]).toFixed(2)}</span><span>${parseFloat(i[1]).toFixed(4)}</span></div>`;
            });
        }
        function handleTicker(d) {
            el('high').innerText = parseFloat(d.h).toFixed(2);
            el('low').innerText = parseFloat(d.l).toFixed(2);
            el('vol').innerText = Math.floor(d.v);
            const chg = parseFloat(d.P);
            el('chg').innerText = chg.toFixed(2) + '%';
            el('chg').style.color = chg>=0?'#0f0':'#f00';
        }

        // --- 5. BLOCKCHAIN FEATURES (NEW) ---
        
        // Gas Tracker (Simulation réaliste pour éviter CORS sans backend)
        // Dans une vraie app, on utiliserait Etherscan API key ici.
        function updateGas() {
            // Simulation d'un Gwei réaliste qui fluctue légèrement
            const baseGwei = 15 + Math.floor(Math.random() * 5); 
            el('gas-val').innerText = baseGwei;
            el('gas-detail').innerText = baseGwei + " Gwei (Low)";
        }
        setInterval(updateGas, 5000); // Update every 5s

        // Wallet Watcher
        function addWallet() {
            const addr = el('wallet-input').value.trim();
            if(addr) {
                savedWallets.push(addr);
                localStorage.setItem('bloomberg_wallets', JSON.stringify(savedWallets));
                renderWallets();
                el('wallet-input').value = '';
            }
        }
        function renderWallets() {
            const c = el('wallet-list');
            c.innerHTML = '';
            savedWallets.forEach((w, i) => {
                const d = document.createElement('div');
                d.className = 'wallet-item';
                d.innerHTML = `<span style="color:var(--blue)">●</span> ${w.substring(0,8)}...${w.substring(38)}`;
                d.onclick = () => window.open('https://etherscan.io/address/'+w, '_blank');
                c.appendChild(d);
            });
        }

        // --- 6. NEWS FEED ---
        async function loadNews() {
            const c = el('tab-news');
            c.innerHTML = '<div style="padding:10px;text-align:center">FETCHING...</div>';
            try {
                const res = await fetch('https://min-api.cryptocompare.com/data/v2/news/?lang=EN');
                const d = await res.json();
                c.innerHTML = '';
                d.Data.slice(0, 15).forEach(n => {
                    const div = document.createElement('div');
                    div.className = 'news-item';
                    div.innerHTML = `<div style="font-size:8px; color:#555">${new Date(n.published_on*1000).toLocaleTimeString()}</div><div>${n.title}</div>`;
                    div.onclick = () => window.open(n.url, '_blank');
                    c.appendChild(div);
                });
            } catch(e) { c.innerHTML = '<div style="padding:10px">NEWS ERROR</div>'; }
        }

        // --- 7. PAPER TRADING ---
        function trade(side) {
            if(isDefiMode) return alert("Paper Trading unavailable in DeFi Mode");
            const p = parseFloat(document.querySelector('.g').innerText);
            const s = parseFloat(el('trade-size').value);
            if(!p) return;
            wallet -= s*0.001; 
            position = { side, entry: p, size: s, amt: s/p };
            updateWalletUI(); saveData();
        }
        function closePos() {
            if(!position) return;
            const p = parseFloat(document.querySelector('.g').innerText);
            const diff = position.side==='long' ? (p - position.entry) : (position.entry - p);
            wallet += diff * position.amt;
            position = null;
            updateWalletUI(); saveData();
        }
        function updateWalletUI() {
            el('wallet-bal').innerText = "$"+wallet.toFixed(2);
            el('pos-box').style.display = position ? 'block' : 'none';
            if(position) el('pos-side').innerText = position.side.toUpperCase();
        }

        // --- UI & TABS ---
        function setTab(t) {
            ['trade', 'chain', 'news'].forEach(x => el('tab-'+x).classList.add('hidden'));
            el('tab-'+t).classList.remove('hidden');
            if(t==='news') loadNews();
        }
        
        // --- BOOT ---
        loadData();
        enableBinanceMode(currentPair);
        updateGas();
        
        // Ticker Line
        const wsTicker = new WebSocket('wss://stream.binance.com:9443/ws/!miniTicker@arr');
        wsTicker.onmessage = e => {
             const d = JSON.parse(e.data).filter(x=>x.s.endsWith('USDT')).sort((a,b)=>parseFloat(b.q)-parseFloat(a.q)).slice(0,15);
             el('global-ticker').innerHTML = d.map(x=>`<span class="tick-item" onclick="handleCommand('${x.s}')">${x.s.replace('USDT','')} <span style="color:${x.P>0?'#0f0':'#f00'}">${parseFloat(x.c).toFixed(2)}</span></span>`).join('');
        };

        // CMD Input
        el('cmd').addEventListener('keypress', e=>{
            if(e.key==='Enter') { handleCommand(e.target.value); e.target.value=''; }
        });
        setInterval(() => el('clock').innerText = new Date().toISOString().split('T')[1].split('.')[0], 1000);

    </script>
</body>
</html>
