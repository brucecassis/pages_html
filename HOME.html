<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLOOMBERG ENS® - TERMINAL</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            --bg: #000000;
            --amber: #ffaa00;
            --dim: #666;
            --green: #00ff00;
            --red: #ff0000;
            --border: #333;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Courier New', monospace; }
        body { background: var(--bg); color: var(--amber); height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-size: 11px; }

        /* HEADER */
        .header { background: var(--amber); color: #000; padding: 4px 10px; font-weight: bold; display: flex; justify-content: space-between; }
        .cmd { background: #111; border-bottom: 1px solid var(--amber); padding: 5px; display: flex; align-items: center; }
        .cmd input { background: transparent; border: none; color: var(--amber); width: 200px; margin-left: 10px; text-transform: uppercase; outline: none; font-weight: bold; }

        /* GRID LAYOUT */
        .grid { display: grid; grid-template-columns: 280px 1fr 280px; grid-template-rows: 1fr 180px; gap: 1px; background: var(--border); flex-grow: 1; }
        .panel { background: var(--bg); display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .title { background: #111; padding: 4px; border-bottom: 1px solid var(--border); color: var(--dim); font-weight: bold; display: flex; justify-content: space-between; }
        
        /* DATA LISTS */
        .list { overflow: hidden; flex-grow: 1; }
        .row { display: flex; justify-content: space-between; padding: 1px 5px; }
        .g { color: var(--green); } .r { color: var(--red); }

        /* CHART */
        #chart { width: 100%; height: 100%; }

        /* STATS BOXES */
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 10px; }
        .box { border: 1px solid var(--border); padding: 5px; }
        .lbl { color: var(--dim); font-size: 9px; }
        .val { font-size: 13px; font-weight: bold; }

        /* FOOTER */
        .foot { background: #111; border-top: 1px solid #333; padding: 5px; color: var(--dim); display: flex; justify-content: space-between; }
    </style>
</head>
<body>

    <div class="header">
        <span>BLOOMBERG ENS TERMINAL</span>
        <span id="time">--:--:-- UTC</span>
    </div>
    
    <div class="cmd">
        <span>COMMAND ></span>
        <input type="text" id="pair" value="BTCUSDT" placeholder="ENTER PAIR...">
        <span style="color:#444">[ENTER TO LOAD]</span>
    </div>

    <div class="grid">
        <div class="panel" style="grid-row: span 2;">
            <div class="title"><span>ORDER BOOK</span><span>DEPTH</span></div>
            <div class="list">
                <div id="asks" style="display:flex; flex-direction:column-reverse;"></div> <div id="spread" style="text-align:center; color:#444; padding:2px;">---</div>
                <div id="bids"></div>
            </div>
        </div>

        <div class="panel">
            <div class="title">
                <span>CHART (1M)</span>
                <span id="price" style="color:var(--amber)">LOADING...</span>
            </div>
            <div id="chart"></div>
        </div>

        <div class="panel" style="grid-row: span 2;">
            <div class="title"><span>TAPE</span><span>TRADES</span></div>
            <div id="tape" class="list"></div>
        </div>

        <div class="panel">
            <div class="title">MARKET DATA (24H)</div>
            <div class="stats">
                <div class="box"><div class="lbl">24H HIGH</div><div class="val" id="high">--</div></div>
                <div class="box"><div class="lbl">24H LOW</div><div class="val" id="low">--</div></div>
                <div class="box"><div class="lbl">24H VOL</div><div class="val" id="vol">--</div></div>
                <div class="box"><div class="lbl">CHANGE %</div><div class="val" id="chg">--</div></div>
            </div>
        </div>
    </div>

    <div class="foot">
        <div id="status">● SYSTEM READY</div>
        <div>BINANCE STREAM (WSS)</div>
    </div>

    <script>
        // --- 1. CONFIG & UTILS ---
        let ws = null;
        let chart, series;
        let currentPair = 'btcusdt';

        const el = (id) => document.getElementById(id);
        const log = (msg) => { el('status').innerText = "● " + msg; };

        // Horloge
        setInterval(() => {
            el('time').innerText = new Date().toISOString().split('T')[1].split('.')[0] + ' UTC';
        }, 1000);

        // --- 2. CHART SETUP ---
        function initChart() {
            const container = el('chart');
            chart = LightweightCharts.createChart(container, {
                layout: { background: { color: '#000000' }, textColor: '#ffaa00' },
                grid: { vertLines: { color: '#111' }, horzLines: { color: '#111' } },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                rightPriceScale: { borderColor: '#333' },
                timeScale: { borderColor: '#333', timeVisible: true }
            });
            series = chart.addCandlestickSeries({
                upColor: '#00ff00', downColor: '#ff0000', borderVisible: false, wickUpColor: '#00ff00', wickDownColor: '#ff0000'
            });
            
            new ResizeObserver(entries => {
                if (entries.length) chart.applyOptions({ width: entries[0].contentRect.width, height: entries[0].contentRect.height });
            }).observe(container);
        }

        // --- 3. WEBSOCKET LOGIC (LE COEUR DU SYSTEME) ---
        function startStream(pair) {
            if (ws) ws.close();
            log("CONNECTING...");

            // On s'abonne à tout d'un coup : Graphique + Profondeur + Trades + Stats 24h
            const streams = [
                `${pair}@kline_1m`,
                `${pair}@depth10`,
                `${pair}@trade`,
                `${pair}@ticker`
            ].join('/');

            ws = new WebSocket(`wss://stream.binance.com:9443/stream?streams=${streams}`);

            ws.onopen = () => { log("STREAM ACTIVE"); el('status').style.color = "#00ff00"; };
            ws.onerror = () => { log("CONNECTION ERROR"); el('status').style.color = "red"; };

            ws.onmessage = (evt) => {
                const msg = JSON.parse(evt.data);
                const type = msg.stream.split('@')[1];
                const data = msg.data;

                // A. Graphique & Prix
                if (type === 'kline_1m') {
                    const k = data.k;
                    series.update({
                        time: k.t / 1000, open: parseFloat(k.o), high: parseFloat(k.h), low: parseFloat(k.l), close: parseFloat(k.c)
                    });
                    el('price').innerText = `${pair.toUpperCase()} : ${parseFloat(k.c).toFixed(2)}`;
                }

                // B. Stats 24H (C'est ça qui manquait !)
                if (type === 'ticker') {
                    el('high').innerText = parseFloat(data.h).toFixed(2);
                    el('low').innerText = parseFloat(data.l).toFixed(2);
                    el('vol').innerText = Math.floor(data.v);
                    const chg = parseFloat(data.P);
                    el('chg').innerHTML = `<span class="${chg >= 0 ? 'g' : 'r'}">${chg.toFixed(2)}%</span>`;
                }

                // C. Carnet d'ordres
                if (type === 'depth10') {
                    renderBook(data.asks, el('asks'), 'r', true); // Vendeurs
                    renderBook(data.bids, el('bids'), 'g', false); // Acheteurs
                    // Spread simple
                    const bestAsk = parseFloat(data.asks[0][0]);
                    const bestBid = parseFloat(data.bids[0][0]);
                    el('spread').innerText = (bestAsk - bestBid).toFixed(2);
                }

                // D. Tape (Trades)
                if (type === 'trade') {
                    const row = document.createElement('div');
                    row.className = 'row';
                    row.innerHTML = `
                        <span style="color:#555">${new Date(data.T).toLocaleTimeString().split(' ')[0]}</span>
                        <span class="${data.m ? 'r' : 'g'}">${parseFloat(data.p).toFixed(2)}</span>
                        <span style="color:#666">${parseFloat(data.q).toFixed(4)}</span>
                    `;
                    const tape = el('tape');
                    tape.prepend(row);
                    if (tape.children.length > 20) tape.lastChild.remove();
                }
            };
        }

        // Helper pour afficher le carnet
        function renderBook(list, container, colorClass, reverse) {
            container.innerHTML = '';
            // On prend juste 5 lignes pour la performance
            const sliced = list.slice(0, 8); 
            // Si c'est les Asks (vendeurs), on inverse l'ordre pour avoir le prix le plus bas en bas
            const dataToRender = reverse ? sliced.reverse() : sliced;
            
            dataToRender.forEach(item => {
                const row = document.createElement('div');
                row.className = 'row';
                row.innerHTML = `<span class="${colorClass}">${parseFloat(item[0]).toFixed(2)}</span><span style="color:#444">${parseFloat(item[1]).toFixed(4)}</span>`;
                container.appendChild(row);
            });
        }

        // --- 4. STARTUP ---
        
        // On initialise le graphique vide
        try {
            initChart();
        } catch(e) {
            console.error("Erreur Graphique", e);
        }

        // On lance le flux
        startStream(currentPair);

        // Gestion Input
        el('pair').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const val = e.target.value.toLowerCase().trim();
                if (val) {
                    currentPair = val;
                    if (series) series.setData([]); // Reset graph
                    el('price').innerText = "SWITCHING...";
                    startStream(currentPair);
                }
            }
        });

    </script>
</body>
</html>
